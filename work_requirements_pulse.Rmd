---
title: "Georgia Medicaid Work Requirements"
output: html_document
date: "2025-03-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r libraries}
library(tidyverse)
library(haven)
library(summarytools)
library(survey)
library(srvyr)
```

## Load data

```{r}
puf_41 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week41_PUF_CSV/pulse2022_puf_41.csv")
puf_42 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week42_PUF_CSV/pulse2022_puf_42.csv")
puf_43 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week43_PUF_CSV/pulse2022_puf_43.csv")
puf_44 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week44_PUF_CSV/pulse2022_puf_44.csv")
puf_45 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week45_PUF_CSV/pulse2022_puf_45.csv")
puf_46 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week46_PUF_CSV/pulse2022_puf_46.csv")
puf_47 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week47_PUF_CSV/pulse2022_puf_47.csv")
puf_48 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week48_PUF_CSV/pulse2022_puf_48.csv")
puf_49 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week49_PUF_CSV/pulse2022_puf_49.csv")
puf_50 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week50_PUF_CSV/pulse2022_puf_50.csv")
puf_51 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week51_PUF_CSV/pulse2022_puf_51.csv")
puf_52 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week52_PUF_CSV/pulse2022_puf_52.csv")
puf_53 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week53_PUF_CSV/pulse2023_puf_53.csv")
puf_54 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week54_PUF_CSV/pulse2023_puf_54.csv")
puf_55 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week55_PUF_CSV/pulse2023_puf_55.csv")
puf_56 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week56_PUF_CSV/pulse2023_puf_56.csv")
puf_57 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week57_PUF_CSV/pulse2023_puf_57.csv")
puf_58 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week58_PUF_CSV/pulse2023_puf_58.csv")
puf_59 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week59_PUF_CSV/pulse2023_puf_59.csv")
puf_60 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week60_PUF_CSV/pulse2023_puf_60.csv")
puf_61 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week61_PUF_CSV/pulse2023_puf_61.csv")
puf_62 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week62_PUF_CSV/pulse2023_puf_62.csv")
puf_63 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week63_PUF_CSV/pulse2023_puf_63.csv")
puf_401 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle01_PUF_CSV/hps_04_00_01_puf.csv")
puf_402 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle02_PUF_CSV/hps_04_00_02_puf.csv")
puf_403 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle03_PUF_CSV/hps_04_00_03_puf.csv")
puf_404 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle04_PUF_CSV/hps_04_01_04_puf.csv")
puf_405 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle05_PUF_CSV/hps_04_01_05_puf.csv")
puf_406 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle06_PUF_CSV/hps_04_01_06_puf.csv")
puf_407 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle07_PUF_CSV/hps_04_01_07_puf.csv")
puf_408 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-2Cycle08_PUF_CSV/hps_04_02_08_puf.csv")
puf_409 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-2Cycle09_PUF_CSV/hps_04_02_09_puf.csv")
```

# Select variables
```{r}
puf_41 <- puf_41 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_42 <- puf_42 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_43 <- puf_43 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_44 <- puf_44 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_45 <- puf_45 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_46 <- puf_46 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_47 <- puf_47 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_48 <- puf_48 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_49 <- puf_49 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_50 <- puf_50 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_51 <- puf_51 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_52 <- puf_52 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_53 <- puf_43 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_54 <- puf_54 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_55 <- puf_55 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_56 <- puf_56 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_57 <- puf_57 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_58 <- puf_58 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_59 <- puf_59 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_60 <- puf_60 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_61 <- puf_61 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_62 <- puf_62 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_63 <- puf_63 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "WEEK")
puf_401 <- puf_401 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_402 <- puf_402 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_403 <- puf_403 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_404 <- puf_404 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_405 <- puf_405 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_406 <- puf_406 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_407 <- puf_407 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_408 <- puf_408 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
puf_409 <- puf_409 %>% select("TBIRTH_YEAR", "RHISPANIC", "RRACE", "EEDUC", "EGENID_BIRTH", "THHLD_NUMPER", "ANYWORK", "HLTHINS1", "HLTHINS2", "HLTHINS3", "HLTHINS4", "HLTHINS5", "HLTHINS6", "HLTHINS7", "HLTHINS8", "INCOME", "EST_ST", "PWEIGHT", "HWEIGHT", "SCRAM", "CYCLE")
```

# Merge data
```{r}
data <- bind_rows(puf_41, puf_42, puf_43, puf_44, puf_45, puf_46, puf_47, puf_48, puf_49, puf_50, puf_51, puf_52, puf_53, puf_54, puf_55, puf_56, puf_57, puf_58, puf_59, puf_60, puf_61, puf_62, puf_63, puf_401, puf_402, puf_403, puf_404, puf_405, puf_406, puf_407, puf_408, puf_409)

rm("puf_41", "puf_42", "puf_43", "puf_44", "puf_45", "puf_46", "puf_47", "puf_48", "puf_49", "puf_50", "puf_51", "puf_52", "puf_53", "puf_54", "puf_55", "puf_56", "puf_57", "puf_58", "puf_59", "puf_60", "puf_61", "puf_62", "puf_63", "puf_401", "puf_402", "puf_403", "puf_404", "puf_405", "puf_406", "puf_407", "puf_408", "puf_409")
```

# Load weights
```{r}
repwgt_puf_41 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week41_PUF_CSV/pulse2022_repwgt_puf_41.csv")
repwgt_puf_42 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week42_PUF_CSV/pulse2022_repwgt_puf_42.csv")
repwgt_puf_43 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week43_PUF_CSV/pulse2022_repwgt_puf_43.csv")
repwgt_puf_44 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week44_PUF_CSV/pulse2022_repwgt_puf_44.csv")
repwgt_puf_45 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week45_PUF_CSV/pulse2022_repwgt_puf_45.csv")
repwgt_puf_46 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week46_PUF_CSV/pulse2022_repwgt_puf_46.csv")
repwgt_puf_47 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week47_PUF_CSV/pulse2022_repwgt_puf_47.csv")
repwgt_puf_48 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week48_PUF_CSV/pulse2022_repwgt_puf_48.csv")
repwgt_puf_49 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week49_PUF_CSV/pulse2022_repwgt_puf_49.csv")
repwgt_puf_50 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week50_PUF_CSV/pulse2022_repwgt_puf_50.csv")
repwgt_puf_51 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week51_PUF_CSV/pulse2022_repwgt_puf_51.csv")
repwgt_puf_52 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week52_PUF_CSV/pulse2022_repwgt_puf_52.csv")
repwgt_puf_53 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week53_PUF_CSV/pulse2023_repwgt_puf_53.csv")
repwgt_puf_54 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week54_PUF_CSV/pulse2023_repwgt_puf_54.csv")
repwgt_puf_55 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week55_PUF_CSV/pulse2023_repwgt_puf_55.csv")
repwgt_puf_56 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week56_PUF_CSV/pulse2023_repwgt_puf_56.csv")
repwgt_puf_57 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week57_PUF_CSV/pulse2023_repwgt_puf_57.csv")
repwgt_puf_58 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week58_PUF_CSV/pulse2023_repwgt_puf_58.csv")
repwgt_puf_59 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week59_PUF_CSV/pulse2023_repwgt_puf_59.csv")
repwgt_puf_60 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week60_PUF_CSV/pulse2023_repwgt_puf_60.csv")
repwgt_puf_61 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week61_PUF_CSV/pulse2023_repwgt_puf_61.csv")
repwgt_puf_62 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week62_PUF_CSV/pulse2023_repwgt_puf_62.csv")
repwgt_puf_63 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Week63_PUF_CSV/pulse2023_repwgt_puf_63.csv")
repwgt_puf_401 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle01_PUF_CSV/hps_04_00_01_repwgt_puf.csv")
repwgt_puf_402 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle02_PUF_CSV/hps_04_00_02_repwgt_puf.csv")
repwgt_puf_403 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4Cycle03_PUF_CSV/hps_04_00_03_repwgt_puf.csv")
repwgt_puf_404 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle04_PUF_CSV/hps_04_01_04_repwgt_puf.csv")
repwgt_puf_405 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle05_PUF_CSV/hps_04_01_05_repwgt_puf.csv")
repwgt_puf_406 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle06_PUF_CSV/hps_04_01_06_repwgt_puf.csv")
repwgt_puf_407 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-1Cycle07_PUF_CSV/hps_04_01_07_repwgt_puf.csv")
repwgt_puf_408 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-2Cycle08_PUF_CSV/hps_04_02_08_repwgt_puf.csv")
repwgt_puf_409 <- read_csv("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/Pulse/HPS_Phase4-2Cycle09_PUF_CSV/hps_04_02_09_repwgt_puf.csv")
```

# Merge weights and data
```{r}
weights <- bind_rows(repwgt_puf_41, repwgt_puf_42, repwgt_puf_43, repwgt_puf_44, repwgt_puf_45, repwgt_puf_46, repwgt_puf_47, repwgt_puf_48, repwgt_puf_49, repwgt_puf_50, repwgt_puf_51, repwgt_puf_52, repwgt_puf_53, repwgt_puf_54, repwgt_puf_55, repwgt_puf_56, repwgt_puf_57, repwgt_puf_58, repwgt_puf_59, repwgt_puf_60, repwgt_puf_61, repwgt_puf_62, repwgt_puf_63, repwgt_puf_401, repwgt_puf_402, repwgt_puf_403, repwgt_puf_404, repwgt_puf_405, repwgt_puf_406, repwgt_puf_407, repwgt_puf_408, repwgt_puf_409)

rm("repwgt_puf_41", "repwgt_puf_42", "repwgt_puf_43", "repwgt_puf_44", "repwgt_puf_45", "repwgt_puf_46", "repwgt_puf_47", "repwgt_puf_48", "repwgt_puf_49", "repwgt_puf_50", "repwgt_puf_51", "repwgt_puf_52", "repwgt_puf_53", "repwgt_puf_54", "repwgt_puf_55", "repwgt_puf_56", "repwgt_puf_57", "repwgt_puf_58", "repwgt_puf_59", "repwgt_puf_60", "repwgt_puf_61", "repwgt_puf_62", "repwgt_puf_63", "repwgt_puf_401", "repwgt_puf_402", "repwgt_puf_403", "repwgt_puf_404", "repwgt_puf_405", "repwgt_puf_406", "repwgt_puf_407", "repwgt_puf_408", "repwgt_puf_409")

data <- data %>% left_join(weights, by = c("SCRAM", "WEEK", "CYCLE"))

rm("weights")
```

# Clean data
```{r}
# Divide PWEIGHT by number of cycles
data$PWEIGHT_divided <- data$PWEIGHT/32

# Clean time and state
data <- data %>%
  mutate(
    week_cycle = case_when(
      !is.na(WEEK) ~ WEEK,
      !is.na(CYCLE) ~ CYCLE + 63,
      TRUE ~ NA_real_
    ),
    date = case_when( # End date of each cycle
      WEEK == 41 ~ as.Date("2022-01-10"),
      WEEK == 42 ~ as.Date("2022-02-07"),
      WEEK == 43 ~ as.Date("2022-03-14"),
      WEEK == 44 ~ as.Date("2022-04-11"),
      WEEK == 45 ~ as.Date("2022-05-09"),
      WEEK == 46 ~ as.Date("2022-06-13"),
      WEEK == 47 ~ as.Date("2022-07-11"),
      WEEK == 48 ~ as.Date("2022-08-08"),
      WEEK == 49 ~ as.Date("2022-09-28"),
      WEEK == 50 ~ as.Date("2022-10-17"),
      WEEK == 51 ~ as.Date("2022-11-14"),
      WEEK == 52 ~ as.Date("2022-12-19"),
      WEEK == 53 ~ as.Date("2023-01-16"),
      WEEK == 54 ~ as.Date("2023-02-13"),
      WEEK == 55 ~ as.Date("2023-03-13"),
      WEEK == 56 ~ as.Date("2023-04-10"),
      WEEK == 57 ~ as.Date("2023-05-08"),
      WEEK == 58 ~ as.Date("2023-06-19"),
      WEEK == 59 ~ as.Date("2023-07-10"),
      WEEK == 60 ~ as.Date("2023-08-07"),
      WEEK == 61 ~ as.Date("2023-09-04"),
      WEEK == 62 ~ as.Date("2023-10-02"),
      WEEK == 63 ~ as.Date("2023-10-30"),
      CYCLE == 1 ~ as.Date("2024-02-05"),
      CYCLE == 2 ~ as.Date("2024-03-04"),
      CYCLE == 3 ~ as.Date("2024-04-01"),
      CYCLE == 4 ~ as.Date("2024-04-29"),
      CYCLE == 5 ~ as.Date("2024-05-27"),
      CYCLE == 6 ~ as.Date("2024-06-24"),
      CYCLE == 7 ~ as.Date("2024-07-22"),
      CYCLE == 8 ~ as.Date("2024-08-19"),
      CYCLE == 9 ~ as.Date("2024-09-16"),
      TRUE ~ NA_Date_
    ),
    year = year(date),
    month = month(date),
    bimonth = case_when(
      year == 2021 & month %in% c(01, 02) ~ "2021 B1",
      year == 2021 & month %in% c(03, 04) ~ "2021 B2",
      year == 2021 & month %in% c(05, 06) ~ "2021 B3",
      year == 2021 & month %in% c(07, 08) ~ "2021 B4",
      year == 2021 & month %in% c(09, 10) ~ "2021 B5",
      year == 2021 & month %in% c(11, 12) ~ "2021 B6",
      year == 2022 & month %in% c(01, 02) ~ "2022 B1",
      year == 2022 & month %in% c(03, 04) ~ "2022 B2",
      year == 2022 & month %in% c(05, 06) ~ "2022 B3",
      year == 2022 & month %in% c(07, 08) ~ "2022 B4",
      year == 2022 & month %in% c(09, 10) ~ "2022 B5",
      year == 2022 & month %in% c(11, 12) ~ "2022 B6",
      year == 2023 & month %in% c(01, 02) ~ "2023 B1",
      year == 2023 & month %in% c(03, 04) ~ "2023 B2",
      year == 2023 & month %in% c(05, 06) ~ "2023 B3",
      year == 2023 & month %in% c(07, 08) ~ "2023 B4",
      year == 2023 & month %in% c(09, 10) ~ "2023 B5",
      year == 2023 & month %in% c(11, 12) ~ "2023 B6",
      year == 2024 & month %in% c(01, 02) ~ "2024 B1",
      year == 2024 & month %in% c(03, 04) ~ "2024 B2",
      year == 2024 & month %in% c(05, 06) ~ "2024 B3",
      year == 2024 & month %in% c(07, 08) ~ "2024 B4",
      year == 2024 & month %in% c(09, 10) ~ "2024 B5",
      year == 2024 & month %in% c(11, 12) ~ "2024 B6",
      TRUE ~ NA_character_
    ),
    quarter = case_when(
      year == 2021 & month %in% c(01, 02, 03) ~ "2021 Q1",
      year == 2021 & month %in% c(04, 05, 06) ~ "2021 Q2",
      year == 2021 & month %in% c(07, 08, 09) ~ "2021 Q3",
      year == 2021 & month %in% c(10, 11, 12) ~ "2021 Q4",
      year == 2022 & month %in% c(01, 02, 03) ~ "2022 Q1",
      year == 2022 & month %in% c(04, 05, 06) ~ "2022 Q2",
      year == 2022 & month %in% c(07, 08, 09) ~ "2022 Q3",
      year == 2022 & month %in% c(10, 11, 12) ~ "2022 Q4",
      year == 2023 & month %in% c(01, 02, 03) ~ "2023 Q1",
      year == 2023 & month %in% c(04, 05, 06) ~ "2023 Q2",
      year == 2023 & month %in% c(07, 08, 09) ~ "2023 Q3",
      year == 2023 & month %in% c(10, 11, 12) ~ "2023 Q4",
      year == 2024 & month %in% c(01, 02, 03) ~ "2024 Q1",
      year == 2024 & month %in% c(04, 05, 06) ~ "2024 Q2",
      year == 2024 & month %in% c(07, 08, 09) ~ "2024 Q3",
      year == 2024 & month %in% c(10, 11, 12) ~ "2024 Q4",
      TRUE ~ NA_character_
    ),
    half = case_when(
      year == 2021 & month %in% c(01, 02, 03, 04, 05, 06) ~ "2021 H1",
      year == 2021 & month %in% c(07, 08, 09, 10, 11, 12) ~ "2021 H2",
      year == 2022 & month %in% c(01, 02, 03, 04, 05, 06) ~ "2022 H1",
      year == 2022 & month %in% c(07, 08, 09, 10, 11, 12) ~ "2022 H2",
      year == 2023 & month %in% c(01, 02, 03, 04, 05, 06) ~ "2023 H1",
      year == 2023 & month %in% c(07, 08, 09, 10, 11, 12) ~ "2023 H2",
      year == 2024 & month %in% c(01, 02, 03, 04, 05, 06) ~ "2024 H1",
      year == 2024 & month %in% c(07, 08, 09, 10, 11, 12) ~ "2024 H2",
      TRUE ~ NA_character_
    ),
    state = case_when(
      EST_ST == "01" ~ "Alabama",
      EST_ST == "02" ~ "Alaska",
      EST_ST == "04" ~ "Arizona",
      EST_ST == "05" ~ "Arkansas",
      EST_ST == "06" ~ "California",
      EST_ST == "08" ~ "Colorado",
      EST_ST == "09" ~ "Connecticut",
      EST_ST == "10" ~ "Delaware",
      EST_ST == "11" ~ "District of Columbia",
      EST_ST == "12" ~ "Florida",
      EST_ST == "13" ~ "Georgia",
      EST_ST == "15" ~ "Hawaii",
      EST_ST == "16" ~ "Idaho",
      EST_ST == "17" ~ "Illinois",
      EST_ST == "18" ~ "Indiana",
      EST_ST == "19" ~ "Iowa",
      EST_ST == "20" ~ "Kansas",
      EST_ST == "21" ~ "Kentucky",
      EST_ST == "22" ~ "Louisiana",
      EST_ST == "23" ~ "Maine",
      EST_ST == "24" ~ "Maryland",
      EST_ST == "25" ~ "Massachusetts",
      EST_ST == "26" ~ "Michigan",
      EST_ST == "27" ~ "Minnesota",
      EST_ST == "28" ~ "Mississippi",
      EST_ST == "29" ~ "Missouri",
      EST_ST == "30" ~ "Montana",
      EST_ST == "31" ~ "Nebraska",
      EST_ST == "32" ~ "Nevada",
      EST_ST == "33" ~ "New Hampshire",
      EST_ST == "34" ~ "New Jersey",
      EST_ST == "35" ~ "New Mexico",
      EST_ST == "36" ~ "New York",
      EST_ST == "37" ~ "North Carolina",
      EST_ST == "38" ~ "North Dakota",
      EST_ST == "39" ~ "Ohio",
      EST_ST == "40" ~ "Oklahoma",
      EST_ST == "41" ~ "Oregon",
      EST_ST == "42" ~ "Pennsylvania",
      EST_ST == "44" ~ "Rhode Island",
      EST_ST == "45" ~ "South Carolina",
      EST_ST == "46" ~ "South Dakota",
      EST_ST == "47" ~ "Tennessee",
      EST_ST == "48" ~ "Texas",
      EST_ST == "49" ~ "Utah",
      EST_ST == "50" ~ "Vermont",
      EST_ST == "51" ~ "Virginia",
      EST_ST == "53" ~ "Washington",
      EST_ST == "54" ~ "West Virginia",
      EST_ST == "55" ~ "Wisconsin",
      EST_ST == "56" ~ "Wyoming"
    )
  )

# Sociodemographic characteristics
data <- data %>% 
  mutate(
    income_num = case_when(
      INCOME == 1 ~ 12500,
      INCOME == 2 ~ 30000,
      INCOME == 3 ~ 42500,
      INCOME == 4 ~ 62500,
      INCOME == 5 ~ 87500,
      INCOME == 6 ~ 125000,
      INCOME == 7 ~ 175000,
      INCOME == 8 ~ 250000,
      TRUE ~ NA_real_
    ),
    fpg = case_when(
      year == 2022 & state != "Alaska" & state != "Hawaii" ~ 100 * (income_num / (8870 + 4720 * THHLD_NUMPER)),
      year == 2022 & state == "Alaska" ~ 100 * (income_num / (11090 + 5900 * THHLD_NUMPER)),
      year == 2022 & state == "Hawaii" ~ 100 * (income_num / (10200 + 5430 * THHLD_NUMPER)),
      year == 2023 & state != "Alaska" & state != "Hawaii" ~ 100 * (income_num / (9440 + 5140 * THHLD_NUMPER)),
      year == 2023 & state == "Alaska" ~ 100 * (income_num / (11780 + 6430 * THHLD_NUMPER)),
      year == 2023 & state == "Hawaii" ~ 100 * (income_num / (10860 + 5910 * THHLD_NUMPER)),
      year == 2024 & state != "Alaska" & state != "Hawaii" ~ 100 * (income_num / (9680 + 5380 * THHLD_NUMPER)),
      year == 2024 & state == "Alaska" ~ 100 * (income_num / (12080 + 6730 * THHLD_NUMPER)),
      year == 2024 & state == "Hawaii" ~ 100 * (income_num / (11120 + 6190 * THHLD_NUMPER)),
      TRUE ~ NA_real_
    ),
    age = year - TBIRTH_YEAR,
    age_cat = case_when(
      age >= 18 & age <= 24 ~ "18-24",
      age >= 25 & age <= 34 ~ "25-34",
      age >= 35 & age <= 44 ~ "35-44",
      age >= 45 & age <= 54 ~ "45-54",
      age >= 55 & age <= 64 ~ "55-64",
      age >= 65 ~ ">65",
      TRUE ~ NA_character_
    ),
    sex_cat = case_when(
      EGENID_BIRTH == 1 ~ "1.Male",
      EGENID_BIRTH == 2 ~ "2.Female",
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      RRACE == 1 ~ "White",
      RRACE == 2 ~ "Black",
      RRACE == 3 ~ "Asian",
      RRACE == 4 ~ "Other",
      TRUE ~ NA_character_
    ),
    race_cat = case_when( # Note: Hispanic ethnicity overrides all other race variables
      RHISPANIC == 1 ~ race_cat,
      RHISPANIC == 2 ~ "Hispanic",
      TRUE ~ race_cat
    ),
    edu_cat = case_when(
      EEDUC == 1 ~ "Less than high school",
      EEDUC == 2 ~ "Some high school",
      EEDUC == 3 ~ "High school graduate",
      EEDUC == 4 ~ "Some college",
      EEDUC == 5 ~ "Associates degree",
      EEDUC == 6 ~ "Bachelors degree",
      EEDUC == 7 ~ "Graduate degree",
      TRUE ~ NA_character_
    )
  )

# Outcomes
data <- data %>%
  mutate(
    medicaid = case_when(
      HLTHINS4 == 1 ~ TRUE,
      HLTHINS1 == -99 & HLTHINS2 == -99 & HLTHINS3 == -99 &
          HLTHINS4 == -99 & HLTHINS5 == -99 & HLTHINS6 == -99 &
          HLTHINS7 == -99 & HLTHINS8 == -99 ~ NA, # If they didn't answer any of the health insurance questions, assign them NA
      HLTHINS1 == -88 & HLTHINS2 == -88 & HLTHINS3 == -88 &
        HLTHINS4 == -88 & HLTHINS5 == -88 & HLTHINS6 == -88 &
        HLTHINS7 == -88 & HLTHINS8 == -88 ~ NA, # If they didn't answer any of the health insurance questions, assign them NA
      TRUE ~ FALSE
    ),
    esi = case_when(
      HLTHINS1 == 1 ~ TRUE,
      HLTHINS1 == -99 & HLTHINS2 == -99 & HLTHINS3 == -99 &
          HLTHINS4 == -99 & HLTHINS5 == -99 & HLTHINS6 == -99 &
          HLTHINS7 == -99 & HLTHINS8 == -99 ~ NA, # If they didn't answer any of the health insurance questions, assign them NA
      HLTHINS1 == -88 & HLTHINS2 == -88 & HLTHINS3 == -88 &
        HLTHINS4 == -88 & HLTHINS5 == -88 & HLTHINS6 == -88 &
        HLTHINS7 == -88 & HLTHINS8 == -88 ~ NA, # If they didn't answer any of the health insurance questions, assign them NA
      TRUE ~ FALSE
    ),
    uninsured = case_when(
      HLTHINS1 == 1 |
        HLTHINS2 == 1 |
        HLTHINS3 == 1 |
        HLTHINS4 == 1 |
        HLTHINS5 == 1 |
        HLTHINS6 == 1 ~ FALSE,
      HLTHINS1 == 2 &
        HLTHINS2 == 2 &
        HLTHINS3 == 2 &
        HLTHINS4 == 2 &
        HLTHINS5 == 2 &
        HLTHINS6 == 2 ~ TRUE,
      HLTHINS7 == 1 ~ TRUE, # Census includes those who have Indian Health Service coverage as uninsured
      TRUE ~ NA
    ),
    employed = case_when(
      ANYWORK == 1 ~ TRUE, 
      ANYWORK == 2 ~ FALSE, 
      TRUE ~ NA
      ),
    not_missing_hi = case_when(
      HLTHINS1 %in% c(1, 2) | 
        HLTHINS2 %in% c(1, 2) | 
        HLTHINS3 %in% c(1, 2) | 
        HLTHINS4 %in% c(1, 2) | 
        HLTHINS5 %in% c(1, 2) | 
        HLTHINS6 %in% c(1, 2) ~ TRUE,
      TRUE ~ NA
    ),
    not_missing_employment = case_when(
      ANYWORK %in% c(1, 2) ~ TRUE,
      TRUE ~ NA
    )
  )

# DID setup
data <- data %>% 
  mutate(
    post = case_when( # Blank out April 1, 2023 - July 31, 2023
      date < ymd("2023-04-01") ~ FALSE,
      date > ymd("2023-07-31") ~ TRUE,
      TRUE ~ NA
    ),
    intervention1 = case_when(
      state == "Georgia" ~ TRUE,
      state == "South Dakota" ~ FALSE,
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi") ~ FALSE, # Test 1
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 2
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina", "Kansas", "Wyoming") ~ FALSE, # Test 3
      # state %in% c("Alabama", "Florida", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 4 best so far
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "South Carolina") ~ FALSE, # Test 5
      # state %in% c("Alabama", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 6
      TRUE ~ NA
    ),
    intervention2 = case_when(
      state == "Georgia" ~ TRUE,
      # state == "South Dakota" ~ FALSE,
      state %in% c("Alabama", "Florida", "Texas", "Mississippi") ~ FALSE, # Test 1
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 2
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina", "Kansas", "Wyoming") ~ FALSE, # Test 3
      # state %in% c("Alabama", "Florida", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 4 best so far
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "South Carolina") ~ FALSE, # Test 5
      # state %in% c("Alabama", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 6
      TRUE ~ NA
    ),
    ,
    intervention3 = case_when(
      state == "Georgia" ~ TRUE,
      # state == "South Dakota" ~ FALSE,
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi") ~ FALSE, # Test 1
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 2
      # state %in% c("Alabama", "Florida", "Texas", "Mississippi", "Tennessee", "South Carolina", "Kansas", "Wyoming") ~ FALSE, # Test 3
      # state %in% c("Alabama", "Florida", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 4 best so far
      state %in% c("Alabama", "Florida", "Texas", "Mississippi", "South Carolina") ~ FALSE, # Test 5
      # state %in% c("Alabama", "Mississippi", "Tennessee", "South Carolina") ~ FALSE, # Test 6
      TRUE ~ NA
    )
  )
```

# Export raw data to Stata
```{r}
write_csv(data, "georgia_data.csv")

# write_dta(data, "georgia_data.dta")

# temp <- read_dta("georgia_data.dta")
# 
# table(data$post)
# table(temp$post)
# 
# table(data$intervention1)
# table(temp$intervention1)
# 
# rm(temp)

sample <- data %>%
  filter(
    (intervention1 %in% c(FALSE, TRUE) | intervention2 %in% c(FALSE, TRUE) | intervention3 %in% c(FALSE, TRUE)) & # Intervention or control group
      age >= 19 & age <= 64 & # 19-64 years old
      fpg <= 100 & # Income up to 100% FPL
      not_missing_hi == TRUE & # Health insurance not missing
      not_missing_employment == TRUE # Employment not missing
  )

write.csv(sample, "georgia_data_filtered.csv", row.names = FALSE)
```

# Create survey object
```{r}
survey <- data %>%
  as_survey_rep(
    repweights = dplyr::matches("PWEIGHT[0-9]+"),
    weights = PWEIGHT_divided,
    type = "BRR",
    mse = TRUE
  )
```

# Select sample
```{r}
sample <- survey %>%
  subset(
    (intervention1 %in% c(FALSE, TRUE) | intervention2 %in% c(FALSE, TRUE) | intervention3 %in% c(FALSE, TRUE)) & # Intervention or control group
      age >= 19 & age <= 64 & # 19-64 years old
      fpg <= 100 & # Income up to 100% FPL
      not_missing_hi == TRUE & # Health insurance not missing
      not_missing_employment == TRUE # Employment not missing
  )

# Subset to pre-period
sample_pre <- sample %>% subset(post == FALSE)

# Subset to post-period
sample_post <- sample %>% subset(post == TRUE)

# Export to Stata
# sample_df <- sample$variables
# sample_df$weights <- weights(sample)
# write.csv(sample_df, "georgia_data_survey.csv", row.names = FALSE)
```

# Plot data - dates
```{r}
# # Medicaid
# medicaid_date <- svyby(~medicaid, ~date + intervention, sample,
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = medicaid,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# medicaid_date_plot <- ggplot(medicaid_date, aes(x = date, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "Date",
#     y = "Medicaid Coverage, %"
#   ) +
#   scale_x_date(
#     date_labels = "%b %Y",
#     date_breaks = "3 month"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# medicaid_date_plot
# #ggsave("medicaid_date_plot_test1.jpg")
# 
# # ESI
# esi_date <- svyby(~esi, ~date + intervention, sample,
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = esi,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# esi_date_plot <- ggplot(esi_date, aes(x = date, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "Date",
#     y = "ESI, %"
#   ) +
#   scale_x_date(
#     date_labels = "%b %Y",
#     date_breaks = "3 month"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# esi_date_plot
# #ggsave("esi_date_plot_south.jpg")
# 
# # Uninsured
# uninsured_date <- svyby(~uninsured, ~date + intervention, sample,
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = uninsured,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# uninsured_date_plot <- ggplot(uninsured_date, aes(x = date, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "Date",
#     y = "Uninsured, %"
#   ) +
#   scale_x_date(
#     date_labels = "%b %Y",
#     date_breaks = "3 month"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# uninsured_date_plot
# #ggsave("uninsured_date_plot_south.jpg")
# 
# # Employed
# employed_date <- svyby(~employed, ~date + intervention, sample,
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = employed,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# employed_date_plot <- ggplot(employed_date, aes(x = date, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "Date",
#     y = "Employed, %"
#   ) +
#   scale_x_date(
#     date_labels = "%b %Y",
#     date_breaks = "3 month"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# employed_date_plot
# #ggsave("employed_date_plot_south.jpg")
```

# Plot data - bimonthly
```{r}
# # Medicaid
# medicaid_bimonth <- svyby(~medicaid, ~bimonth + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = medicaid,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# medicaid_bimonth_plot <- ggplot(medicaid_bimonth, aes(x = bimonth, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "bimonth",
#     y = "Medicaid Coverage, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# medicaid_bimonth_plot
# #ggsave("medicaid_bimonth_plot_test1.jpg")
# 
# # ESI
# esi_bimonth <- svyby(~esi, ~bimonth + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = esi,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# esi_bimonth_plot <- ggplot(esi_bimonth, aes(x = bimonth, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "bimonth",
#     y = "ESI, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# esi_bimonth_plot
# #ggsave("esi_bimonth_plot_south.jpg")
# 
# # Uninsured
# uninsured_bimonth <- svyby(~uninsured, ~bimonth + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = uninsured,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# uninsured_bimonth_plot <- ggplot(uninsured_bimonth, aes(x = bimonth, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "bimonth",
#     y = "Uninsured, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# uninsured_bimonth_plot
# #ggsave("uninsured_bimonth_plot_south.jpg")
# 
# # Employed
# employed_bimonth <- svyby(~employed, ~bimonth + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = employed,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# employed_bimonth_plot <- ggplot(employed_bimonth, aes(x = bimonth, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "bimonth",
#     y = "Employed, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# employed_bimonth_plot
# #ggsave("employed_bimonth_plot_south.jpg")
```

# Plot data - quarters
```{r}
# Medicaid
medicaid_quarter <- svyby(~medicaid, ~quarter + intervention, sample_pre,
                       svymean, vartype = "se", na.rm = TRUE) %>%
  as.data.frame() %>%
  rename(
    percentage = medicaid,
    se = se
  ) %>%
  mutate(
    percentage = percentage * 100,
    se = se * 100,
    lower = pmax(percentage - 1.96 * se, 0),
    upper = pmin(percentage + 1.96 * se, 100)
  )

medicaid_quarter_plot <- ggplot(medicaid_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    x = "",
    y = "Medicaid Coverage, %"
  ) +
  scale_color_discrete(labels = c("South Dakota", "Georgia")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  ylim(0, 100)

medicaid_quarter_plot
#ggsave("medicaid_quarter_plot_test6.jpg")

# ESI
esi_quarter <- svyby(~esi, ~quarter + intervention, sample_pre,
                       svymean, vartype = "se", na.rm = TRUE) %>%
  as.data.frame() %>%
  rename(
    percentage = esi,
    se = se
  ) %>%
  mutate(
    percentage = percentage * 100,
    se = se * 100,
    lower = pmax(percentage - 1.96 * se, 0),
    upper = pmin(percentage + 1.96 * se, 100)
  )

esi_quarter_plot <- ggplot(esi_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    x = "",
    y = "ESI, %"
  ) +
  scale_color_discrete(labels = c("South Dakota", "Georgia")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  ylim(0, 100)

esi_quarter_plot
#ggsave("esi_quarter_plot_test6.jpg")

# Uninsured
uninsured_quarter <- svyby(~uninsured, ~quarter + intervention, sample_pre,
                       svymean, vartype = "se", na.rm = TRUE) %>%
  as.data.frame() %>%
  rename(
    percentage = uninsured,
    se = se
  ) %>%
  mutate(
    percentage = percentage * 100,
    se = se * 100,
    lower = pmax(percentage - 1.96 * se, 0),
    upper = pmin(percentage + 1.96 * se, 100)
  )

uninsured_quarter_plot <- ggplot(uninsured_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    x = "",
    y = "Uninsured, %"
  ) +
  scale_color_discrete(labels = c("South Dakota", "Georgia")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  ylim(0, 100)

uninsured_quarter_plot
#ggsave("uninsured_quarter_plot_test6.jpg")

# Employed
employed_quarter <- svyby(~employed, ~quarter + intervention, sample_pre,
                       svymean, vartype = "se", na.rm = TRUE) %>%
  as.data.frame() %>%
  rename(
    percentage = employed,
    se = se
  ) %>%
  mutate(
    percentage = percentage * 100,
    se = se * 100,
    lower = pmax(percentage - 1.96 * se, 0),
    upper = pmin(percentage + 1.96 * se, 100)
  )

employed_quarter_plot <- ggplot(employed_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(
    x = "",
    y = "Employed, %"
  ) +
  scale_color_discrete(labels = c("South Dakota", "Georgia")) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  ylim(0, 100)

employed_quarter_plot
#ggsave("employed_quarter_plot_test6.jpg")
```


# Plot data - differences by quarter
```{r}
# # Compute weighted percentages and standard errors
# medicaid_weighted <- svyby(~medicaid, ~half + intervention, sample, 
#                            svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = medicaid,  # Weighted proportion
#     se = se                 # Weighted standard error
#   ) %>%
#   mutate(percentage = percentage * 100, se = se * 100)  # Convert to percentage scale
# 
# # Reshape the data to calculate differences
# medicaid_diff <- medicaid_weighted %>%
#   pivot_wider(names_from = intervention, values_from = c(percentage, se), names_prefix = "group_") %>%
#   rename(
#     percentage_control = percentage_group_FALSE,  # Control group (AL, FL, TX, MS)
#     percentage_treatment = percentage_group_TRUE, # Treatment group (Georgia)
#     se_control = se_group_FALSE,
#     se_treatment = se_group_TRUE
#   ) %>%
#   mutate(
#     diff_percentage = percentage_treatment - percentage_control,  # Difference: Georgia - Control states
#     diff_se = sqrt(se_treatment^2 + se_control^2),  # Weighted SE using delta method
#     lower = diff_percentage - 1.96 * diff_se,  # Lower bound of 95% CI
#     upper = diff_percentage + 1.96 * diff_se   # Upper bound of 95% CI
#   )
# 
# # Plot the difference with weighted error bars
# medicaid_diff_plot <- ggplot(medicaid_diff, aes(x = half, y = diff_percentage)) +
#   geom_line(color = "blue") +
#   geom_point(color = "blue") +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "blue") +
#   labs(
#     x = "half",
#     y = "Difference in Medicaid Coverage (%)"
#   ) +
#   # scale_x_half(
#   #   half_labels = "%b %Y",
#   #   half_breaks = "3 month"
#   # ) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   ylim(min(medicaid_diff$lower, na.rm = TRUE), max(medicaid_diff$upper, na.rm = TRUE))
# 
# medicaid_diff_plot
# 
# 

```
# Plot data - halves
```{r}
# # Medicaid
# medicaid_half <- svyby(~medicaid, ~half + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = medicaid,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# medicaid_half_plot <- ggplot(medicaid_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "half",
#     y = "Medicaid Coverage, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# medicaid_half_plot
# #ggsave("medicaid_half_plot_test1.jpg")
# 
# # ESI
# esi_half <- svyby(~esi, ~half + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = esi,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# esi_half_plot <- ggplot(esi_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "half",
#     y = "ESI, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# esi_half_plot
# #ggsave("esi_half_plot_south.jpg")
# 
# # Uninsured
# uninsured_half <- svyby(~uninsured, ~half + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = uninsured,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# uninsured_half_plot <- ggplot(uninsured_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "half",
#     y = "Uninsured, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# uninsured_half_plot
# #ggsave("uninsured_half_plot_south.jpg")
# 
# # Employed
# employed_half <- svyby(~employed, ~half + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = employed,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# employed_half_plot <- ggplot(employed_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "half",
#     y = "Employed, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# employed_half_plot
# #ggsave("employed_half_plot_south.jpg")
```

# Plot data - years
```{r}
# # Medicaid
# medicaid_year <- svyby(~medicaid, ~year + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = medicaid,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# medicaid_year_plot <- ggplot(medicaid_year, aes(x = year, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "year",
#     y = "Medicaid Coverage, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# medicaid_year_plot
# #ggsave("medicaid_year_plot_test1.jpg")
# 
# # ESI
# esi_year <- svyby(~esi, ~year + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = esi,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# esi_year_plot <- ggplot(esi_year, aes(x = year, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "year",
#     y = "ESI, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# esi_year_plot
# #ggsave("esi_year_plot_south.jpg")
# 
# # Uninsured
# uninsured_year <- svyby(~uninsured, ~year + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = uninsured,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# uninsured_year_plot <- ggplot(uninsured_year, aes(x = year, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "year",
#     y = "Uninsured, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# uninsured_year_plot
# #ggsave("uninsured_year_plot_south.jpg")
# 
# # Employed
# employed_year <- svyby(~employed, ~year + intervention, sample, 
#                        svymean, vartype = "se", na.rm = TRUE) %>%
#   as.data.frame() %>%
#   rename(
#     percentage = employed,
#     se = se
#   ) %>%
#   mutate(
#     percentage = percentage * 100,
#     se = se * 100,
#     lower = pmax(percentage - 1.96 * se, 0),
#     upper = pmin(percentage + 1.96 * se, 100)
#   )
# 
# employed_year_plot <- ggplot(employed_year, aes(x = year, y = percentage, color = intervention, group = intervention)) +
#   geom_line() +
#   geom_point() +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
#   labs(
#     x = "year",
#     y = "Employed, %"
#   ) +
#   scale_color_discrete(labels = c("Southern states", "Georgia")) +
#   theme_minimal() +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     legend.position = "bottom"
#   ) +
#   ylim(0, 100)
# 
# employed_year_plot
# #ggsave("employed_year_plot_south.jpg")
```

# Test parallel trends
```{r}
# Georgia vs. South Dakota
## Medicaid
medicaid_pttest1 <- svyglm(medicaid ~ intervention1 * date, design = sample_pre)
summary(medicaid_pttest1)

## Employer-sponsored insurance
esi_pttest1 <- svyglm(esi ~ intervention1 * date, design = sample_pre)
summary(esi_pttest1)

## Uninsured
uninsured_pttest1 <- svyglm(uninsured ~ intervention1 * date, design = sample_pre)
summary(uninsured_pttest1)

## Employed
employed_pttest1 <- svyglm(employed ~ intervention1 * date, design = sample_pre)
summary(employed_pttest1)

# Georgia vs. Alabama, Florida, Texas, Mississippi
## Medicaid
medicaid_pttest2 <- svyglm(medicaid ~ intervention2 * date, design = sample_pre)
summary(medicaid_pttest2)

## Employer-sponsored insurance
esi_pttest2 <- svyglm(esi ~ intervention2 * date, design = sample_pre)
summary(esi_pttest2)

## Uninsured
uninsured_pttest2 <- svyglm(uninsured ~ intervention2 * date, design = sample_pre)
summary(uninsured_pttest2)

## Employed
employed_pttest2 <- svyglm(employed ~ intervention2 * date, design = sample_pre)
summary(employed_pttest2)

# Georgia vs. Alabama, Florida, Mississippi, Texas, South Carolina
## Medicaid
medicaid_pttest3 <- svyglm(medicaid ~ intervention3 * date, design = sample_pre)
summary(medicaid_pttest3)

## Employer-sponsored insurance
esi_pttest3 <- svyglm(esi ~ intervention3 * date, design = sample_pre)
summary(esi_pttest3)

## Uninsured
uninsured_pttest3 <- svyglm(uninsured ~ intervention3 * date, design = sample_pre)
summary(uninsured_pttest3)

## Employed
employed_pttest3 <- svyglm(employed ~ intervention3 * date, design = sample_pre)
summary(employed_pttest3)
```

# Unadjusted DID analysis
```{r}
# # Medicaid
# medicaid_unadj <- svyglm(medicaid ~ intervention * post, design = sample)
# summary(medicaid_unadj)
# 
# # Employer-sponsored insurance
# esi_unadj <- svyglm(esi ~ intervention * post, design = sample)
# summary(esi_unadj)
# 
# # Uninsured
# uninsured_unadj <- svyglm(uninsured ~ intervention * post, design = sample)
# summary(uninsured_unadj)
# 
# # Employed
# employed_unadj <- svyglm(employed ~ intervention * post, design = sample)
# summary(employed_unadj)
```

# Adjusted DID analysis
```{r}
# Medicaid
medicaid_adj <- svyglm(medicaid ~ intervention * post + age_cat + sex_cat, design = sample)
summary(medicaid_adj)

# Employer-sponsored insurance
esi_adj <- svyglm(esi ~ intervention * post + age_cat + sex_cat, design = sample)
summary(esi_adj)

# Uninsured
uninsured_adj <- svyglm(uninsured ~ intervention * post + age_cat + sex_cat, design = sample)
summary(uninsured_adj)

# Employed
employed_adj <- svyglm(employed ~ intervention * post + age_cat + sex_cat, design = sample)
summary(employed_adj)
```

# Create DID table
```{r}
# # Define function to fill in diff-in-diff table
# gen_did_tbl <- function(outcome_var, unadj_model, adj_model, survey_design, z_value = 1.96) {
#   # Tabulate the average percentages in the pre and post time periods for intervention == 1
#   tbl_t <- svyby(as.formula(paste0("~", outcome_var)), ~post, subset(survey_design, intervention == 1), svymean, vartype = c("ci"), na.rm = TRUE)
#   
#   # Tabulate the average percentages in the pre and post time periods for intervention == 0
#   tbl_c <- svyby(as.formula(paste0("~", outcome_var)), ~post, subset(survey_design, intervention == 0), svymean, vartype = c("ci"), na.rm = TRUE)
#   
#   # Extract the means and confidence intervals for intervention == 1 
#   pre_mean_t <- tbl_t[tbl_t$post == 0, outcome_var]
#   ci_pre_low_t <- tbl_t[tbl_t$post == 0, "ci_l"]
#   ci_pre_upp_t <- tbl_t[tbl_t$post == 0, "ci_u"]
#   post_mean_t <- tbl_t[tbl_t$post == 1, outcome_var]
#   ci_post_low_t <- tbl_t[tbl_t$post == 1, "ci_l"]
#   ci_post_upp_t <- tbl_t[tbl_t$post == 1, "ci_u"]
#   
#   # Convert to percentage points for intervention == 1
#   pre_mean_percent_t <- pre_mean_t * 100
#   ci_pre_low_percent_t <- ci_pre_low_t * 100
#   ci_pre_upp_percent_t <- ci_pre_upp_t * 100
#   post_mean_percent_t <- post_mean_t * 100
#   ci_post_low_percent_t <- ci_post_low_t * 100
#   ci_post_upp_percent_t <- ci_post_upp_t * 100
#   
#   # Calculate the difference for intervention == 1
#   diff_mean_t <- post_mean_t - pre_mean_t
#   
#   # Calculate the standard error of the difference for intervention == 1
#   diff_se_t <- sqrt((((tbl_t[tbl_t$post == 1, "ci_u"] - post_mean_t))/z_value)^2 + 
#                     (((pre_mean_t - tbl_t[tbl_t$post == 0, "ci_l"]))/z_value)^2)
#   
#   # Calculate the confidence interval for intervention == 1
#   ci_diff_low_t <- diff_mean_t - z_value * diff_se_t
#   ci_diff_upp_t <- diff_mean_t + z_value * diff_se_t
#   
#   # Convert to percentage points for intervention == 1
#   diff_mean_percent_t <- diff_mean_t * 100
#   ci_diff_low_percent_t <- ci_diff_low_t * 100
#   ci_diff_upp_percent_t <- ci_diff_upp_t * 100
#   
#   # Extract the means and confidence intervals for intervention == 0
#   pre_mean_c <- tbl_c[tbl_c$post == 0, outcome_var]
#   ci_pre_low_c <- tbl_c[tbl_c$post == 0, "ci_l"]
#   ci_pre_upp_c <- tbl_c[tbl_c$post == 0, "ci_u"]
#   post_mean_c <- tbl_c[tbl_c$post == 1, outcome_var]
#   ci_post_low_c <- tbl_c[tbl_c$post == 1, "ci_l"]
#   ci_post_upp_c <- tbl_c[tbl_c$post == 1, "ci_u"]
#   
#   # Convert to percentage points for intervention == 0
#   pre_mean_percent_c <- pre_mean_c * 100
#   ci_pre_low_percent_c <- ci_pre_low_c * 100
#   ci_pre_upp_percent_c <- ci_pre_upp_c * 100
#   post_mean_percent_c <- post_mean_c * 100
#   ci_post_low_percent_c <- ci_post_low_c * 100
#   ci_post_upp_percent_c <- ci_post_upp_c * 100
#   
#   # Calculate the difference for intervention == 0
#   diff_mean_c <- post_mean_c - pre_mean_c
#   
#   # Calculate p value for intervention == 1
#   did_ttest_t <- svyttest(as.formula(paste0(outcome_var, " ~ post")), design = subset(survey_design, intervention == 1))
#   did_pval_t <- formatC(did_ttest_t$p.value, format = "f", digits = 4)
#   
#   # Calculate the standard error of the difference for intervention == 0
#   diff_se_c <- sqrt((((tbl_c[tbl_c$post == 1, "ci_u"] - post_mean_c))/z_value)^2 +
#                     (((pre_mean_c - tbl_c[tbl_c$post == 0, "ci_l"]))/z_value)^2)
#   
#   # Calculate the confidence interval for intervention == 0
#   ci_diff_low_c <- diff_mean_c - z_value * diff_se_c
#   ci_diff_upp_c <- diff_mean_c + z_value * diff_se_c
#   
#   # Convert to percentage points for intervention == 0
#   diff_mean_percent_c <- diff_mean_c * 100
#   ci_diff_low_percent_c <- ci_diff_low_c * 100
#   ci_diff_upp_percent_c <- ci_diff_upp_c * 100
#   
#   # Calculate p value for intervention == 0
#   did_ttest_c <- svyttest(as.formula(paste0(outcome_var, " ~ post")), design = subset(survey_design, intervention == 0))
#   did_pval_c <- formatC(did_ttest_c$p.value, format = "f", digits = 4)
#   
#   # Print the results for intervention == 1
#   cat("Intervention group:\n")
#   cat(paste0("Pre period mean: ", formatC(pre_mean_percent_t, format = "f", digits = 2), " (", 
#              formatC(ci_pre_low_percent_t, format = "f", digits = 2), ", ", 
#              formatC(ci_pre_upp_percent_t, format = "f", digits = 2), ")\n"))
#   cat(paste0("Post period mean: ", formatC(post_mean_percent_t, format = "f", digits = 2), " (", 
#              formatC(ci_post_low_percent_t, format = "f", digits = 2), ", ",
#              formatC(ci_post_upp_percent_t, format = "f", digits = 2), ")\n"))
#   cat(paste0("Difference: ", formatC(diff_mean_percent_t, format = "f", digits = 2), " (", 
#              formatC(ci_diff_low_percent_t, format = "f", digits = 2), ", ",
#              formatC(ci_diff_upp_percent_t, format = "f", digits = 2), ")\n"))
#   cat(paste0("P value: ", formatC(did_pval_t, format = "f", digits = 4), "\n\n"))
#   
#   # Print the results for intervention == 0
#   cat("Control group:\n")
#   cat(paste0("Pre period mean: ", formatC(pre_mean_percent_c, format = "f", digits = 2), " (", 
#              formatC(ci_pre_low_percent_c, format = "f", digits = 2), ", ",
#              formatC(ci_pre_upp_percent_c, format = "f", digits = 2), ")\n"))
#   cat(paste0("Post period mean: ", formatC(post_mean_percent_c, format = "f", digits = 2), " (", 
#              formatC(ci_post_low_percent_c, format = "f", digits = 2), ", ",
#              formatC(ci_post_upp_percent_c, format = "f", digits = 2), ")\n"))
#   cat(paste0("Difference: ", formatC(diff_mean_percent_c, format = "f", digits = 2), " (", 
#              formatC(ci_diff_low_percent_c, format = "f", digits = 2), ", ",
#              formatC(ci_diff_upp_percent_c, format = "f", digits = 2), ")\n"))
#   cat(paste0("P value: ", formatC(did_pval_c, format = "f", digits = 4), "\n\n"))
#   
#   # Extract estimates, confidence intervals, and p-values for both models
#   
#   # Unadjusted Model
#   unadj_diff_in_diff <- coef(unadj_model)["intervention:post"] * 100
#   unadj_ci <- confint(unadj_model)["intervention:post", ] * 100
#   unadj_p_value <- summary(unadj_model)$coefficients["intervention:post", "Pr(>|t|)"]
#   
#   # Adjusted Model
#   adj_diff_in_diff <- coef(adj_model)["intervention:post"] * 100
#   adj_ci <- confint(adj_model)["intervention:post", ] * 100
#   adj_p_value <- summary(adj_model)$coefficients["intervention:post", "Pr(>|t|)"]
#   
#   # Print the results for the unadjusted model
#   cat("\nUnadjusted Model:\n")
#   cat(paste0("Difference-in-Difference Estimate: ", formatC(unadj_diff_in_diff, format = "f", digits = 2), " (", 
#       formatC(unadj_ci[1], format = "f", digits = 2), ", ", 
#       formatC(unadj_ci[2], format = "f", digits = 2), ")\n"))
#   cat(paste0("p-value: ", formatC(unadj_p_value, format = "f", digits = 2), "\n"))
#   
#   # Print the results for the adjusted model
#   cat(paste0("\nAdjusted Model:\n"))
#   cat(paste0("Difference-in-Difference Estimate: ", formatC(adj_diff_in_diff, format = "f", digits = 2), " (", 
#       formatC(adj_ci[1], format = "f", digits = 2), ", ", 
#       formatC(adj_ci[2], format = "f", digits = 2), ")\n"))
#   cat(paste0("p-value: ", formatC(adj_p_value, format = "f", digits = 2), "\n"))
# }
# 
# # Run on outcomes
# gen_did_tbl("medicaid", medicaid_unadj, medicaid_adj, sample)
# gen_did_tbl("esi", esi_unadj, esi_adj, sample)
# gen_did_tbl("uninsured", uninsured_unadj, uninsured_adj, sample)
# gen_did_tbl("employed", employed_unadj, employed_adj, sample)
```

# Create baseline characteristics table
```{r}
# # Define a function to generate a table and chi-square test
# gen_table_chisq <- function(variable, group_var, survey_design) {
#   # Calculate the weighted percentages and confidence intervals for the input variable by the group variable
#   tbl <- svyby(as.formula(paste("~", variable)), as.formula(paste("~", group_var)), survey_design, svymean, vartype = c("ci"), na.rm = TRUE)
#   
#   # Generate a Chi-square test to compare the input variable across the group variable
#   chi_test <- svychisq(as.formula(paste("~", variable, "+", group_var)), design = survey_design)
#   
#   # Return the table and chi-square test result as a list
#   list(
#     table = tbl,
#     chi_square = chi_test
#   )
# }
# 
# # Split sample into pre and post
# sample_pre <- sample %>%
#   subset(post == 0)
# 
# sample_post <- sample %>%
#   subset(post == 1)
# 
# # Total study population
# total <- svytable(~intervention, design = sample) %>% as.data.frame()
# total
# 
# # Tabulate weighted respondent characteristics in pre period
# total_tbl_pre_u <- table(sample_pre$variables$intervention)
# total_tbl_pre_u
# 
# total_tbl_pre_w <- svytable(~intervention, design = sample_pre) %>% as.data.frame()
# total_tbl_pre_w
# 
# age_tbl_pre <- svyby(~age, ~intervention, sample_pre, svymean, vartype = c("se"), na.rm = TRUE)
# age_tbl_pre
# age_tbl_pre_p <- svyttest(age~intervention, sample_pre)
# age_tbl_pre_p
# 
# sex_tbl_pre <- gen_table_chisq("sex_cat", "intervention", sample_pre)
# sex_tbl_pre$table
# sex_tbl_pre$chi_square
# 
# race_tbl_pre <- gen_table_chisq("race_cat", "intervention", sample_pre)
# race_tbl_pre$table
# race_tbl_pre$chi_square
# 
# education_tbl_pre <- gen_table_chisq("education_cat", "intervention", sample_pre)
# education_tbl_pre$table
# education_tbl_pre$chi_square
# 
# dm_tbl_pre <- gen_table_chisq("dm", "intervention", sample_pre)
# dm_tbl_pre$table
# dm_tbl_pre$chi_square
# 
# mi_tbl_pre <- gen_table_chisq("mi", "intervention", sample_pre)
# mi_tbl_pre$table
# mi_tbl_pre$chi_square
# 
# stroke_tbl_pre <- gen_table_chisq("stroke", "intervention", sample_pre)
# stroke_tbl_pre$table
# stroke_tbl_pre$chi_square
# 
# copd_tbl_pre <- gen_table_chisq("copd", "intervention", sample_pre)
# copd_tbl_pre$table
# copd_tbl_pre$chi_square
# 
# cancer_tbl_pre <- gen_table_chisq("cancer", "intervention", sample_pre)
# cancer_tbl_pre$table
# cancer_tbl_pre$chi_square
# 
# # Tabulate weighted respondent characteristics in post periods
# total_tbl_post_u <- table(sample_post$variables$intervention)
# total_tbl_post_u
# 
# total_tbl_post_w <- svytable(~intervention, design = sample_post) %>% as.data.frame()
# total_tbl_post_w
# 
# age_tbl_post <- svyby(~age, ~intervention, sample_post, svymean, vartype = c("se"), na.rm = TRUE)
# age_tbl_post
# age_tbl_post_p <- svyttest(age~intervention, sample_post)
# age_tbl_post_p
# 
# sex_tbl_post <- gen_table_chisq("sex_cat", "intervention", sample_post)
# sex_tbl_post$table
# sex_tbl_post$chi_square
# 
# race_tbl_post <- gen_table_chisq("race_cat", "intervention", sample_post)
# race_tbl_post$table
# race_tbl_post$chi_square
# 
# education_tbl_post <- gen_table_chisq("education_cat", "intervention", sample_post)
# education_tbl_post$table
# education_tbl_post$chi_square
```

# Playground
```{r}
# table(data$medicaid, data$medicaid2)
# 
# table(data$medicaid, data$state)
# 
# georgia <- data %>% filter(state == "Georgia")
# 
# table(georgia$medicaid)
# 
# svytable(~medicaid2 + year + state, survey)
# 
# 
# 
# georgia <- survey %>%
#   subset(
#     state == "Georgia"
#   )
# 
# svytable(~medicaid + year, georgia)
# 164437.59 / (164437.59 + 3183231.13)
# 
# svytable(~medicaid2 + year, georgia)
# 440619.47 / (440619.47 + 2849981.11)
# 
# # Step 1: Fit survey-weighted logistic regression model for Medicaid coverage
# medicaid_model <- svyglm(medicaid ~ quarter * intervention + age_cat, 
#                          design = sample_pre)
# 
# # Step 2: Create a dataset for prediction (marginal means by quarter & intervention)
# new_data <- expand.grid(
#   quarter = unique(sample_pre$variables$quarter),
#   intervention = c(TRUE, FALSE),
#   age_cat = unique(sample_pre$variables$age_cat)#,  # Use all valid levels of age_cat
#   # sex_cat = unique(sample_pre$variables$sex_cat)   # Use all valid levels of sex_cat
# )
# 
# # Step 3: Predict adjusted Medicaid probabilities with standard errors
# preds <- predict(medicaid_model, newdata = new_data, type = "response", se.fit = TRUE)
# 
# # Step 4: Store results in a dataframe
# medicaid_adjusted <- new_data %>%
#   mutate(
#     percentage = preds$fit * 100,   # Convert probability to percentage
#     se = preds$se.fit * 100,        # Convert SE to percentage
#     lower = percentage - 1.96 * se, # 95% CI Lower Bound
#     upper = percentage + 1.96 * se  # 95% CI Upper Bound
#   )
# 
# # Step 5: Compute adjusted difference between groups
# medicaid_diff_adjusted <- medicaid_adjusted %>%
#   pivot_wider(names_from = intervention, values_from = c(percentage, se), names_prefix = "group_") %>%
#   rename(
#     percentage_control = group_FALSE,  
#     percentage_treatment = group_TRUE, 
#     se_control = group_se_FALSE,
#     se_treatment = group_se_TRUE
#   ) %>%
#   mutate(
#     diff_percentage = percentage_treatment - percentage_control,
#     diff_se = sqrt(se_treatment^2 + se_control^2),  # Delta method for SE
#     lower = diff_percentage - 1.96 * diff_se,
#     upper = diff_percentage + 1.96 * diff_se
#   )
# 
# # Step 6: Plot adjusted differences over time
# medicaid_diff_plot <- ggplot(medicaid_diff_adjusted, aes(x = quarter, y = diff_percentage)) +
#   geom_line(color = "blue") +
#   geom_point(color = "blue") +
#   geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, color = "blue") +
#   labs(
#     title = "Adjusted Difference in Medicaid Coverage (Age & Sex Adjusted)",
#     x = "Quarter",
#     y = "Difference in Medicaid Coverage (%)"
#   ) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   ylim(min(medicaid_diff_adjusted$lower, na.rm = TRUE), max(medicaid_diff_adjusted$upper, na.rm = TRUE))
# 
# medicaid_diff_plot
```