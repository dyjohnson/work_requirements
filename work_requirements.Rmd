---
title: "Georgia Medicaid Work Requirements"
output: html_document
date: "2024-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r libraries}
library(tidyverse)
library(haven)
library(summarytools)
library(survey)
```

## Load data

```{r}
# Load the datasets
llcp2022 <- read_xpt("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/BRFSS/Data/LLCP2022.XPT")
llcp2023 <- read_xpt("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/BRFSS/Data/LLCP2023.XPT")
```

# Clean BRFSS 2022
```{r}
# Federal Poverty 2022 calculations
llcp2022 <- llcp2022 %>%
  mutate(
    hhadult_clean = ifelse(HHADULT %in% c(77, 99), NA, HHADULT),
    children_clean = ifelse(CHILDREN == 99, NA, ifelse(CHILDREN == 88, 0, CHILDREN)),
    hh_size = ifelse(is.na(NUMADULT), 1, NUMADULT) + ifelse(is.na(hhadult_clean), 0, hhadult_clean) + ifelse(is.na(children_clean), 0, children_clean),
    hh_size = ifelse(hh_size == 0 | hh_size > 9, 1, hh_size), # Exclude 0 or >99th percentile (9)
    income_num = case_when(
      INCOME3 == 1 ~ 5000,
      INCOME3 == 2 ~ 12500,
      INCOME3 == 3 ~ 17500,
      INCOME3 == 4 ~ 22500,
      INCOME3 == 5 ~ 30000,
      INCOME3 == 6 ~ 42500,
      INCOME3 == 7 ~ 62500,
      INCOME3 == 8 ~ 87500,
      INCOME3 == 9 ~ 125000,
      INCOME3 == 10 ~ 175000,
      INCOME3 == 11 ~ 200000,
      TRUE ~ NA_real_
    ),
    fpg = case_when(
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 1 ~ 100 * (income_num / 13590),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 2 ~ 100 * (income_num / 18310),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 3 ~ 100 * (income_num / 23030),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 4 ~ 100 * (income_num / 27750),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 5 ~ 100 * (income_num / 32470),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 6 ~ 100 * (income_num / 37190),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 7 ~ 100 * (income_num / 41910),
      `_STATE` != 2 & `_STATE` != 15 & hh_size >= 8 ~ 100 * (income_num / (46630 + (hh_size - 8) * 4720)),
      `_STATE` == 2 & hh_size == 1 ~ 100 * (income_num / 16990),
      `_STATE` == 2 & hh_size == 2 ~ 100 * (income_num / 22890),
      `_STATE` == 2 & hh_size == 3 ~ 100 * (income_num / 28790),
      `_STATE` == 2 & hh_size == 4 ~ 100 * (income_num / 34690),
      `_STATE` == 2 & hh_size == 5 ~ 100 * (income_num / 40590),
      `_STATE` == 2 & hh_size == 6 ~ 100 * (income_num / 46490),
      `_STATE` == 2 & hh_size == 7 ~ 100 * (income_num / 52390),
      `_STATE` == 2 & hh_size >= 8 ~ 100 * (income_num / (58290 + (hh_size - 8) * 5900)),
      `_STATE` == 15 & hh_size == 1 ~ 100 * (income_num / 15630),
      `_STATE` == 15 & hh_size == 2 ~ 100 * (income_num / 21060),
      `_STATE` == 15 & hh_size == 3 ~ 100 * (income_num / 26490),
      `_STATE` == 15 & hh_size == 4 ~ 100 * (income_num / 31920),
      `_STATE` == 15 & hh_size == 5 ~ 100 * (income_num / 37350),
      `_STATE` == 15 & hh_size == 6 ~ 100 * (income_num / 42780),
      `_STATE` == 15 & hh_size == 7 ~ 100 * (income_num / 48210),
      `_STATE` == 15 & hh_size >= 8 ~ 100 * (income_num / (53640 + (hh_size - 8) * 5430)),
      TRUE ~ NA_real_
    ),
    age = `_AGE80`,
    age_cat = case_when(
      `_AGE80` >= 18 & `_AGE80` <= 24 ~ "18-24",
      `_AGE80` >= 25 & `_AGE80` <= 34 ~ "25-34",
      `_AGE80` >= 35 & `_AGE80` <= 44 ~ "35-44",
      `_AGE80` >= 45 & `_AGE80` <= 54 ~ "45-54",
      `_AGE80` >= 55 & `_AGE80` <= 64 ~ "55-64",
      `_AGE80` >= 65 ~ ">65",
      TRUE ~ NA_character_
    ),
    sex_cat = case_when(
      SEXVAR == 1 ~ "1.Male",
      SEXVAR == 2 ~ "2.Female",
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      `_IMPRACE` == 1 ~ "1.Non-Hispanic White",
      `_IMPRACE` == 2 ~ "2.Non-Hispanic Black",
      `_IMPRACE` == 3 ~ "3.Non-Hispanic Asian",
      `_IMPRACE` == 5 ~ "4.Hispanic",
      `_IMPRACE` %in% c(4, 6) ~ "5.Other",
      TRUE ~ NA_character_
    ),
    education_cat = case_when(
      EDUCA %in% c(5, 6) ~ "College educated",
      EDUCA %in% c(1, 2, 3, 4) ~ "Not college educated",
      TRUE ~ NA_character_
    ),
    medicaid = ifelse(PRIMINSR == 5, 1, 0),
    esi = ifelse(PRIMINSR == 1, 1, 0),
    uninsured = ifelse(`_HLTHPLN` == 2, 1, ifelse(`_HLTHPLN` == 1, 0, NA)),
    employed = ifelse(EMPLOY1 %in% c(1, 2), 1, 0),
    student = ifelse(EMPLOY1 == 6, 1, 0),
    qualifying = ifelse(EMPLOY1 %in% c(1, 2, 6), 1, 0),
    pcp = ifelse(PERSDOC3 %in% c(1, 2), 1, ifelse(PERSDOC3 == 3, 0, NA)),
    not_afford = ifelse(MEDCOST1 == 1, 1, ifelse(MEDCOST1 == 2, 0, NA)),
    dm = ifelse(DIABETE4 == 1, 1, ifelse(DIABETE4 %in% c(2, 3, 4), 0, NA)),
    mi = ifelse(CVDINFR4 == 1, 1, ifelse(CVDINFR4 == 2, 0, NA)),
    chd = ifelse(CVDCRHD4 == 1, 1, ifelse(CVDCRHD4 == 2, 0, NA)),
    stroke = ifelse(CVDSTRK3 == 1, 1, ifelse(CVDSTRK3 == 2, 0, NA)),
    copd = ifelse(CHCCOPD3 == 1, 1, ifelse(CHCCOPD3 == 2, 0, NA)),
    cancer = ifelse(CHCOCNC1 == 1, 1, ifelse(CHCOCNC1 == 2, 0, NA)),
    unemployed = ifelse(EMPLOY1 %in% c(3, 4), 1, 0)
  )
```

# Clean BRFSS 2023
```{r}
# Federal Poverty 2023 calculations
llcp2023 <- llcp2023 %>%
  mutate(
    hhadult_clean = ifelse(HHADULT %in% c(77, 99), NA, HHADULT),
    children_clean = ifelse(CHILDREN == 99, NA, ifelse(CHILDREN == 88, 0, CHILDREN)),
    hh_size = ifelse(is.na(NUMADULT), 1, NUMADULT) + ifelse(is.na(hhadult_clean), 0, hhadult_clean) + ifelse(is.na(children_clean), 0, children_clean),
    hh_size = ifelse(hh_size == 0 | hh_size > 9, 1, hh_size), # Exclude 0 or >99th percentile (9)
    income_num = case_when(
      INCOME3 == 1 ~ 5000,
      INCOME3 == 2 ~ 12500,
      INCOME3 == 3 ~ 17500,
      INCOME3 == 4 ~ 22500,
      INCOME3 == 5 ~ 30000,
      INCOME3 == 6 ~ 42500,
      INCOME3 == 7 ~ 62500,
      INCOME3 == 8 ~ 87500,
      INCOME3 == 9 ~ 125000,
      INCOME3 == 10 ~ 175000,
      INCOME3 == 11 ~ 200000,
      TRUE ~ NA_real_
    ),
    fpg = case_when(
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 1 ~ 100 * (income_num / 14580),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 2 ~ 100 * (income_num / 19720),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 3 ~ 100 * (income_num / 24860),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 4 ~ 100 * (income_num / 30000),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 5 ~ 100 * (income_num / 35140),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 6 ~ 100 * (income_num / 40280),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 7 ~ 100 * (income_num / 45420),
      `_STATE` != 2 & `_STATE` != 15 & hh_size >= 8 ~ 100 * (income_num / (50560 + (hh_size - 8) * 5140)),
      `_STATE` == 2 & hh_size == 1 ~ 100 * (income_num / 18210),
      `_STATE` == 2 & hh_size == 2 ~ 100 * (income_num / 24640),
      `_STATE` == 2 & hh_size == 3 ~ 100 * (income_num / 31070),
      `_STATE` == 2 & hh_size == 4 ~ 100 * (income_num / 37500),
      `_STATE` == 2 & hh_size == 5 ~ 100 * (income_num / 43930),
      `_STATE` == 2 & hh_size == 6 ~ 100 * (income_num / 50360),
      `_STATE` == 2 & hh_size == 7 ~ 100 * (income_num / 56790),
      `_STATE` == 2 & hh_size >= 8 ~ 100 * (income_num / (63220 + (hh_size - 8) * 6430)),
      `_STATE` == 15 & hh_size == 1 ~ 100 * (income_num / 16770),
      `_STATE` == 15 & hh_size == 2 ~ 100 * (income_num / 22680),
      `_STATE` == 15 & hh_size == 3 ~ 100 * (income_num / 28590),
      `_STATE` == 15 & hh_size == 4 ~ 100 * (income_num / 34500),
      `_STATE` == 15 & hh_size == 5 ~ 100 * (income_num / 40410),
      `_STATE` == 15 & hh_size == 6 ~ 100 * (income_num / 46320),
      `_STATE` == 15 & hh_size == 7 ~ 100 * (income_num / 52230),
      `_STATE` == 15 & hh_size >= 8 ~ 100 * (income_num / (58140 + (hh_size - 8) * 5910)),
      TRUE ~ NA_real_
    ),
    age = `_AGE80`,
    age_cat = case_when(
      `_AGE80` >= 18 & `_AGE80` <= 24 ~ "18-24",
      `_AGE80` >= 25 & `_AGE80` <= 34 ~ "25-34",
      `_AGE80` >= 35 & `_AGE80` <= 44 ~ "35-44",
      `_AGE80` >= 45 & `_AGE80` <= 54 ~ "45-54",
      `_AGE80` >= 55 & `_AGE80` <= 64 ~ "55-64",
      `_AGE80` >= 65 ~ ">65",
      TRUE ~ NA_character_
    ),
    sex_cat = case_when(
      SEXVAR == 1 ~ "1.Male",
      SEXVAR == 2 ~ "2.Female",
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      `_IMPRACE` == 1 ~ "1.Non-Hispanic White",
      `_IMPRACE` == 2 ~ "2.Non-Hispanic Black",
      `_IMPRACE` == 3 ~ "3.Non-Hispanic Asian",
      `_IMPRACE` == 5 ~ "4.Hispanic",
      `_IMPRACE` %in% c(4, 6) ~ "5.Other",
      TRUE ~ NA_character_
    ),
    education_cat = case_when(
      EDUCA %in% c(5, 6) ~ "College educated",
      EDUCA %in% c(1, 2, 3, 4) ~ "Not college educated",
      TRUE ~ NA_character_
    ),
    medicaid = ifelse(PRIMINS1 == 5, 1, 0),
    esi = ifelse(PRIMINS1 == 1, 1, 0),
    uninsured = ifelse(`_HLTHPL1` == 2, 1, ifelse(`_HLTHPL1` == 1, 0, NA)),
    employed = ifelse(EMPLOY1 %in% c(1, 2), 1, 0),
    student = ifelse(EMPLOY1 == 6, 1, 0),
    qualifying = ifelse(EMPLOY1 %in% c(1, 2, 6), 1, 0),
    pcp = ifelse(PERSDOC3 %in% c(1, 2), 1, ifelse(PERSDOC3 == 3, 0, NA)),
    not_afford = ifelse(MEDCOST1 == 1, 1, ifelse(MEDCOST1 == 2, 0, NA)),
    dm = ifelse(DIABETE4 == 1, 1, ifelse(DIABETE4 %in% c(2, 3, 4), 0, NA)),
    mi = ifelse(CVDINFR4 == 1, 1, ifelse(CVDINFR4 == 2, 0, NA)),
    chd = ifelse(CVDCRHD4 == 1, 1, ifelse(CVDCRHD4 == 2, 0, NA)),
    stroke = ifelse(CVDSTRK3 == 1, 1, ifelse(CVDSTRK3 == 2, 0, NA)),
    copd = ifelse(CHCCOPD3 == 1, 1, ifelse(CHCCOPD3 == 2, 0, NA)),
    cancer = ifelse(CHCOCNC1 == 1, 1, ifelse(CHCOCNC1 == 2, 0, NA)),
    htn = ifelse(BPHIGH6 == 1, 1, ifelse(BPHIGH6 %in% c(2, 3, 4), 0, NA)),
    hld = ifelse(TOLDHI3 == 1, 1, ifelse(TOLDHI3 == 2, 0, NA)),
    unemployed = ifelse(EMPLOY1 %in% c(3, 4), 1, 0)
  )
```

# Merge data
```{r}
# Merge datasets
merge_2223 <- bind_rows(llcp2022, llcp2023)
```

# Clean merged data
```{r}
merge_2223 <- merge_2223 %>%
  mutate(
    post = case_when(
      IYEAR == 2022 | (IYEAR == 2023 & IMONTH %in% c("01", "02", "03", "04", "05", "06")) ~ 0,
      IYEAR == 2023 & IMONTH %in% c("07", "08", "09", "10", "11", "12") ~ 1,
      TRUE ~ NA_real_
    ),
    prepost = case_when(
      IYEAR == 2022 & IMONTH %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09") ~ 0,
      (IYEAR == 2022 & IMONTH %in% c("10", "11", "12")) | (IYEAR == 2023 & IMONTH %in% c("01", "02", "03", "04", "05", "06")) ~ 1,
      TRUE ~ NA_real_
    ),
    intervention = case_when(
      `_STATE` == 13 ~ 1, # Georgia
      `_STATE` %in% c(1, 12, 48, 28) ~ 0, # Alabama, Florida, Texas, Mississippi
      TRUE ~ NA_real_
    ),
    quarter = case_when(
      IYEAR == 2022 & IMONTH %in% c("01", "02", "03") ~ "1. 2022 Q1",
      IYEAR == 2022 & IMONTH %in% c("04", "05", "06") ~ "2. 2022 Q2",
      IYEAR == 2022 & IMONTH %in% c("07", "08", "09") ~ "3. 2022 Q3",
      IYEAR == 2022 & IMONTH %in% c("10", "11", "12") ~ "4. 2022 Q4",
      IYEAR == 2023 & IMONTH %in% c("01", "02", "03") ~ "5. 2023 Q1",
      IYEAR == 2023 & IMONTH %in% c("04", "05", "06") ~ "6. 2023 Q2",
      IYEAR == 2023 & IMONTH %in% c("07", "08", "09") ~ "7. 2023 Q3",
      IYEAR == 2023 & IMONTH %in% c("10", "11", "12") ~ "8. 2023 Q4",
      TRUE ~ NA_character_
    ),
    half = case_when(
      IYEAR == 2022 & IMONTH %in% c("01", "02", "03", "04", "05", "06") ~ "1. 2022 H1",
      IYEAR == 2022 & IMONTH %in% c("07", "08", "09", "10", "11", "12") ~ "2. 2022 H2",
      IYEAR == 2023 & IMONTH %in% c("01", "02", "03", "04", "05", "06") ~ "3. 2023 H1",
      IYEAR == 2023 & IMONTH %in% c("07", "08", "09", "10", "11", "12") ~ "4. 2023 H2",
      TRUE ~ NA_character_
    ),
    state = case_when(
      `_STATE` == 1 ~ "Alabama",
      `_STATE` == 2 ~ "Alaska",
      `_STATE` == 4 ~ "Arizona",
      `_STATE` == 5 ~ "Arkansas",
      `_STATE` == 6 ~ "California",
      `_STATE` == 8 ~ "Colorado",
      `_STATE` == 9 ~ "Connecticut",
      `_STATE` == 10 ~ "Delaware",
      `_STATE` == 11 ~ "District of Columbia",
      `_STATE` == 12 ~ "Florida",
      `_STATE` == 13 ~ "Georgia",
      `_STATE` == 15 ~ "Hawaii",
      `_STATE` == 16 ~ "Idaho",
      `_STATE` == 17 ~ "Illinois",
      `_STATE` == 18 ~ "Indiana",
      `_STATE` == 19 ~ "Iowa",
      `_STATE` == 20 ~ "Kansas",
      `_STATE` == 21 ~ "Kentucky",
      `_STATE` == 22 ~ "Louisiana",
      `_STATE` == 23 ~ "Maine",
      `_STATE` == 24 ~ "Maryland",
      `_STATE` == 25 ~ "Massachusetts",
      `_STATE` == 26 ~ "Michigan",
      `_STATE` == 27 ~ "Minnesota",
      `_STATE` == 28 ~ "Mississippi",
      `_STATE` == 29 ~ "Missouri",
      `_STATE` == 30 ~ "Montana",
      `_STATE` == 31 ~ "Nebraska",
      `_STATE` == 32 ~ "Nevada",
      `_STATE` == 33 ~ "New Hampshire",
      `_STATE` == 34 ~ "New Jersey",
      `_STATE` == 35 ~ "New Mexico",
      `_STATE` == 36 ~ "New York",
      `_STATE` == 37 ~ "North Carolina",
      `_STATE` == 38 ~ "North Dakota",
      `_STATE` == 39 ~ "Ohio",
      `_STATE` == 40 ~ "Oklahoma",
      `_STATE` == 41 ~ "Oregon",
      `_STATE` == 42 ~ "Pennsylvania",
      `_STATE` == 44 ~ "Rhode Island",
      `_STATE` == 45 ~ "South Carolina",
      `_STATE` == 46 ~ "South Dakota",
      `_STATE` == 47 ~ "Tennessee",
      `_STATE` == 48 ~ "Texas",
      `_STATE` == 49 ~ "Utah",
      `_STATE` == 50 ~ "Vermont",
      `_STATE` == 51 ~ "Virginia",
      `_STATE` == 53 ~ "Washington",
      `_STATE` == 54 ~ "West Virginia",
      `_STATE` == 55 ~ "Wisconsin",
      `_STATE` == 56 ~ "Wyoming"
    ),
    disability = case_when(BLIND == 1 |
                             DEAF == 1 |
                             DECIDE == 1 |
                             DIFFWALK == 1 |
                             DIFFDRES == 1 |
                             DIFFALON == 1 ~ 1,
                           TRUE ~ NA_real_)
  )
```

# Filter then select target population
```{r}
# eligible2_raw <- merge_2223 %>%
#   filter(
#     `_STATE` %in% c(13, 1, 12, 48, 28) &
#       # Georgia, Alabama, Florida, Texas, Mississippi residents
#       `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
#       fpg <= 100 & # Income up to 100% FPL
#       (PREGNANT != 1 | is.na(PREGNANT)) & # Not pregnant
#       (BLIND != 1 | is.na(BLIND)) & # Not legally blind
#       (DEAF != 1 | is.na(DEAF)) & # Not deaf
#       (DECIDE != 1 | is.na(DECIDE)) & # No difficulty with cognition
#       (DIFFWALK != 1 |
#          is.na(DIFFWALK)) & # No difficulty with mobility
#       (DIFFDRES != 1 |
#          is.na(DIFFDRES)) & # No difficulty with self-care
#       (DIFFALON != 1 |
#          is.na(DIFFALON)) & # No difficulty with independent living
#       (children_clean == 0 | (children_clean >= 1 &
#          fpg > 30)) & # No parents with income under 30% FPL
#       IYEAR %in% c(2022, 2023) # Date range: 1/1/2022 - 12/31/2023
#     # Exclude "unable to work"?
#   )
# 
# eligible2 <- svydesign(id = ~`_PSU`, strata = ~`_STSTR`, weights = ~`_LLCPWT`, data = eligible2_raw, nest = TRUE)
# options(survey.lonely.psu = "adjust")
```


# Create survey object
```{r}
# Create survey design object
survey_2223 <- svydesign(id = ~`_PSU`, strata = ~`_STSTR`, weights = ~`_LLCPWT`, data = merge_2223, nest = TRUE)

# Handle single-PSU strata by treating them as adjusted PSU
options(survey.lonely.psu = "adjust")
```

# Select target population
```{r}
eligible <- survey_2223 %>%
  subset(
    `_STATE` %in% c(13, 1, 12, 48, 28) &
      # Georgia, Alabama, Florida, Texas, Mississippi residents
      `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
      fpg <= 100 & # Income up to 100% FPL
      (PREGNANT != 1 | is.na(PREGNANT)) & # Not pregnant
      (BLIND != 1 | is.na(BLIND)) & # Not legally blind
      (DEAF != 1 | is.na(DEAF)) & # Not deaf
      (DECIDE != 1 | is.na(DECIDE)) & # No difficulty with cognition
      (DIFFWALK != 1 |
         is.na(DIFFWALK)) & # No difficulty with mobility
      (DIFFDRES != 1 |
         is.na(DIFFDRES)) & # No difficulty with self-care
      (DIFFALON != 1 |
         is.na(DIFFALON)) & # No difficulty with independent living
      (children_clean == 0 | (children_clean >= 1 &
         fpg > 30)) & # No parents with income under 30% FPL
      IYEAR %in% c(2022, 2023) # Date range: 1/1/2022 - 12/31/2023
    # Exclude "unable to work"?
  )
# 
# working_age_ga <- survey_2223 %>%
#   subset(
#     `_STATE` %in% c(13) &
#       # Georgia residents
#       `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
#       IYEAR %in% c(2022, 2023) # Date range: 1/1/2022 - 12/31/2023
#     # Exclude "unable to work"?
#   )
# 
# all_ga <- survey_2223 %>%
#   subset(
#     `_STATE` %in% c(13) &
#       # Georgia residents
#       # `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
#       IYEAR %in% c(2022, 2023) # Date range: 1/1/2022 - 12/31/2023
#     # Exclude "unable to work"?
#   )
# 
# all_ga_raw <- merge_2223 %>% filter(`_STATE` %in% c(13))
# 
# ga_2223 <- svydesign(id = ~`_PSU`, strata = ~`_STSTR`, weights = ~`_LLCPWT`, data = all_ga_raw, nest = TRUE)
```

# Data exploration
```{r}
# # Unweighted number of observations
# nrow(eligible)
# 
# # Weighted number of observations
# svytable(~intervention, eligible)
# svytable(~post, eligible)
# svytable(~intervention + post, eligible)
# 
# # Georgia, Alabama, Florida, Texas, Mississippi residents
# svytable(~`_STATE`, eligible, exclude=NULL, na.action=na.pass)
# svytable(~`_STATE` + intervention, eligible, exclude=NULL, na.action=na.pass)
# 
# # 19-64 years old
# svytable(~`_AGE80`, eligible, exclude=NULL, na.action=na.pass)
#   
# # Income up to 100% FPL
# svytable(~fpg, eligible, exclude=NULL, na.action=na.pass)
#   
# # Not pregnant
# svytable(~PREGNANT, eligible, exclude=NULL, na.action=na.pass)
#   
# # Not legally blind
# svytable(~BLIND, eligible, exclude=NULL, na.action=na.pass)
#     
# # Not deaf
# svytable(~DEAF, eligible, exclude=NULL, na.action=na.pass)
#   
# # No difficulty with cognition
# svytable(~DECIDE, eligible, exclude=NULL, na.action=na.pass)  
#   
# # No difficulty with mobility
# svytable(~DIFFWALK, eligible, exclude=NULL, na.action=na.pass)  
#   
# # No difficulty with self-care
# svytable(~DIFFDRES, eligible, exclude=NULL, na.action=na.pass)  
#   
# # No difficulty with independent living
# svytable(~DIFFALON, eligible, exclude=NULL, na.action=na.pass) 
#   
# # No parents with income under 30% FPL
# svytable(~children_clean + fpg, eligible, exclude=NULL, na.action=na.pass) 
#   
# # Date range: 1/1/2022 - 12/31/2023
# svytable(~IMONTH + IYEAR, eligible, exclude=NULL, na.action=na.pass) 
# 
# # Age category
# svytable(~age_cat + intervention, eligible, exclude=NULL, na.action=na.pass) 
# 
# # Sex 
# svytable(~sex_cat + intervention, eligible, exclude=NULL, na.action=na.pass)
# 
# # Race
# svytable(~race_cat + intervention, eligible, exclude=NULL, na.action=na.pass)
# 
# # Education
# svytable(~education_cat + intervention, eligible, exclude=NULL, na.action=na.pass)
# 
# # Medicaid
# svytable(~medicaid + PRIMINS1, eligible, exclude=NULL, na.action=na.pass)
# svytable(~medicaid + PRIMINSR, eligible, exclude=NULL, na.action=na.pass)
# 
# # ESI
# svytable(~esi + PRIMINS1, eligible, exclude=NULL, na.action=na.pass)
# svytable(~esi + PRIMINSR, eligible, exclude=NULL, na.action=na.pass)
# 
# # Uninsured
# svytable(~uninsured + `_HLTHPL1`, eligible, exclude=NULL, na.action=na.pass)
# svytable(~uninsured + `_HLTHPLN`, eligible, exclude=NULL, na.action=na.pass)
# 
# svytable(~uninsured + `_HCVU653`, eligible, exclude=NULL, na.action=na.pass)
# svytable(~uninsured + `_HCVU652`, eligible, exclude=NULL, na.action=na.pass)
# 
# svytable(~uninsured + PRIMINS1, eligible, exclude=NULL, na.action=na.pass)
# svytable(~uninsured + PRIMINSR, eligible, exclude=NULL, na.action=na.pass)
# 
# # Employed
# svytable(~employed + EMPLOY1, eligible, exclude=NULL, na.action=na.pass)
# 
# # Student
# svytable(~student + EMPLOY1, eligible, exclude=NULL, na.action=na.pass)
# 
# # Qualifying
# svytable(~qualifying + EMPLOY1, eligible, exclude=NULL, na.action=na.pass)
# 
# # PCP
# svytable(~pcp + PERSDOC3, eligible, exclude=NULL, na.action=na.pass)
# 
# # Not afford
# svytable(~not_afford + MEDCOST1, eligible, exclude=NULL, na.action=na.pass)
# 
# # Diabetes
# svytable(~dm + DIABETE4, eligible, exclude=NULL, na.action=na.pass)
# 
# # MI
# svytable(~mi + CVDINFR4, eligible, exclude=NULL, na.action=na.pass)
# 
# # Stroke
# svytable(~stroke + CVDSTRK3, eligible, exclude=NULL, na.action=na.pass)
# 
# # COPD
# svytable(~copd + CHCCOPD3, eligible, exclude=NULL, na.action=na.pass)
#     
# # Cancer
# svytable(~cancer + CHCOCNC1, eligible, exclude=NULL, na.action=na.pass)
# 
# # Intervention
# svytable(~intervention + `_STATE`, eligible, exclude=NULL, na.action=na.pass)
# 
# # Post
# svytable(~post + IMONTH + IYEAR, eligible, exclude=NULL, na.action=na.pass)
# 
# # Insurance coverage
# svytable(~medicaid + post + intervention, eligible)
# svytable(~uninsured + post + intervention, eligible)
# svytable(~esi + post + intervention, eligible)
```

# Medicaid population
```{r}
# # Medicaid population
# eligible_medicaid <- eligible %>%
#   subset(medicaid == 1)
# 
# # Unweighted number of observations
# nrow(eligible_medicaid)
# 
# # Weighted number of observations
# svytable(~state, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Insurance
# svytable(~medicaid, eligible_medicaid, exclude=NULL, na.action=na.pass)
# svytable(~PRIMINSR + PRIMINS1, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Pre post
# svytable(~post, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Interview month and year
# svytable(~IMONTH + IYEAR, eligible_medicaid, exclude=NULL, na.action=na.pass)
# svytable(~IMONTH + IYEAR + medicaid, eligible, exclude=NULL, na.action=na.pass)
# 
# # Pre post and intervention
# svytable(~post + intervention, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Pre post and intervention
# svytable(~post, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Age
# svytable(~age_cat, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Sex
# svytable(~sex_cat, eligible_medicaid, exclude=NULL, na.action=na.pass)
# svytable(~sex_cat + medicaid, eligible, exclude=NULL, na.action=na.pass)
# 
# # Income
# svytable(~fpg, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Family size
# svytable(~hh_size, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Children
# svytable(~children_clean, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Children ages
# svytable(~CAGEG, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Family size and income
# svytable(~hh_size + fpg, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Employment
# svytable(~EMPLOY1 + medicaid + post, eligible, exclude=NULL, na.action=na.pass)
# 
# # Student
# svytable(~student + EMPLOY1, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Qualifying
# svytable(~qualifying + medicaid + post, eligible, exclude=NULL, na.action=na.pass)
# 
# # Pregnant
# svytable(~PREGNANT + post, eligible_medicaid, exclude=NULL, na.action=na.pass)
# 
# # Cancer
# svytable(~cancer + medicaid, eligible, exclude=NULL, na.action=na.pass)
```

# Test parallel trends
```{r}
# Medicaid
medicaid_unadj_pttest <- svyglm(medicaid ~ intervention * prepost, design = eligible)
summary(medicaid_unadj_pttest)

# Uninsured
uninsured_unadj_pttest <- svyglm(uninsured ~ intervention * prepost, design = eligible)
summary(uninsured_unadj_pttest)

# Qualifying activities
qualifying_unadj_pttest <- svyglm(qualifying ~ intervention * prepost, design = eligible)
summary(qualifying_unadj_pttest)

# Employed
employed_unadj_pttest <- svyglm(employed ~ intervention * prepost, design = eligible)
summary(employed_unadj_pttest)

# Student
student_unadj_pttest <- svyglm(student ~ intervention * prepost, design = eligible)
summary(student_unadj_pttest)

# Employer-sponsored insurance
esi_unadj_pttest <- svyglm(esi ~ intervention * prepost, design = eligible)
summary(esi_unadj_pttest)

# Access to PCP
pcp_unadj_pttest <- svyglm(pcp ~ intervention * prepost, design = eligible)
summary(pcp_unadj_pttest)

# Cost-related delays in care
not_afford_unadj_pttest <- svyglm(not_afford ~ intervention * prepost, design = eligible)
summary(not_afford_unadj_pttest)
```

# Plot data - prepost
```{r}
# Medicaid coverage
medicaid_summary <- svytable(~medicaid + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_plot <- ggplot(medicaid_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had Medicaid",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_plot
ggsave("medicaid_plot.jpg")

# ESI
esi_summary <- svytable(~esi + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_plot <- ggplot(esi_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had employer-sponsored insurance",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_plot
ggsave("esi_plot.jpg")

# Uninsured
uninsured_summary <- svytable(~uninsured + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_plot <- ggplot(uninsured_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Uninsured",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_plot
ggsave("uninsured_plot.jpg")

# Qualifying activities
qualifying_summary <- svytable(~qualifying + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_plot <- ggplot(qualifying_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Qualifying activities",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_plot
ggsave("qualifying_plot.jpg")

# Employed
employed_summary <- svytable(~employed + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_plot <- ggplot(employed_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Employed",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_plot
ggsave("employed_plot.jpg")

# Student
student_summary <- svytable(~student + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_plot <- ggplot(student_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Student",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_plot
ggsave("student_plot.jpg")

# PCP
pcp_summary <- svytable(~pcp + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_plot <- ggplot(pcp_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Has PCP",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_plot
ggsave("pcp_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_summary <- svytable(~not_afford + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_plot <- ggplot(not_afford_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_plot
ggsave("not_afford_plot.jpg")

# Unemployed
unemployed_summary <- svytable(~unemployed + post + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    unemployed_1 = sum(Freq[unemployed == 1]),
    percentage = (unemployed_1 / total) * 100
  ) %>%
  ungroup()

unemployed_plot <- ggplot(unemployed_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Unemployed",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  scale_x_discrete(labels = c("Control States", "Georgia")) +
  scale_fill_discrete(labels = c("Pre", "Post")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

unemployed_plot
ggsave("unemployed_plot.jpg")
```

# Plot data - prepost all
```{r}
# Medicaid coverage
medicaid_summary <- svytable(~medicaid + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_all_plot <- ggplot(medicaid_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had Medicaid",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_all_plot
ggsave("medicaid_all_plot.jpg")

# ESI
esi_summary <- svytable(~esi + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_all_plot <- ggplot(esi_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had employer-sponsored insurance",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_all_plot
ggsave("esi_all_plot.jpg")

# Uninsured
uninsured_summary <- svytable(~uninsured + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_all_plot <- ggplot(uninsured_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Uninsured",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_all_plot
ggsave("uninsured_all_plot.jpg")

# Qualifying activities
qualifying_summary <- svytable(~qualifying + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_all_plot <- ggplot(qualifying_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Qualifying activities",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_all_plot
ggsave("qualifying_all_plot.jpg")

# Employed
employed_summary <- svytable(~employed + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_all_plot <- ggplot(employed_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Employed",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_all_plot
ggsave("employed_all_plot.jpg")

# Student
student_summary <- svytable(~student + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_all_plot <- ggplot(student_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Student",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_all_plot
ggsave("student_all_plot.jpg")

# PCP
pcp_summary <- svytable(~pcp + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_all_plot <- ggplot(pcp_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Has PCP",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_all_plot
ggsave("pcp_all_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_summary <- svytable(~not_afford + post + intervention, survey_2223) %>%
  as.data.frame() %>%
  group_by(post, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_all_plot <- ggplot(not_afford_summary, aes(x = intervention, y = percentage, fill = post)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_all_plot
ggsave("not_afford_all_plot.jpg")
```

# Plot data - quarters
```{r}
# Medicaid coverage
medicaid_quarter <- svytable(~medicaid + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_quarter_plot <- ggplot(medicaid_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has Medicaid",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_quarter_plot
ggsave("medicaid_quarter_plot.jpg")

# ESI
esi_quarter <- svytable(~esi + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_quarter_plot <- ggplot(esi_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has employer-sponsored insurance",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_quarter_plot
ggsave("esi_quarter_plot.jpg")

# Uninsured
uninsured_quarter <- svytable(~uninsured + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_quarter_plot <- ggplot(uninsured_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Uninsured",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_quarter_plot
ggsave("uninsured_quarter_plot.jpg")

# Qualifying activities
qualifying_quarter <- svytable(~qualifying + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_quarter_plot <- ggplot(qualifying_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Qualifying activities",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_quarter_plot
ggsave("qualifying_quarter_plot.jpg")

# Employed
employed_quarter <- svytable(~employed + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_quarter_plot <- ggplot(employed_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Employed",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_quarter_plot
ggsave("employed_quarter_plot.jpg")

# Student
student_quarter <- svytable(~student + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_quarter_plot <- ggplot(student_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Student",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_quarter_plot
ggsave("student_quarter_plot.jpg")

# PCP
pcp_quarter <- svytable(~pcp + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_quarter_plot <- ggplot(pcp_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "PCP",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_quarter_plot
ggsave("pcp_quarter_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_quarter <- svytable(~not_afford + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_quarter_plot <- ggplot(not_afford_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_quarter_plot
ggsave("not_afford_quarter_plot.jpg")

# Unemployed
unemployed_quarter <- svytable(~unemployed + quarter + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    unemployed_1 = sum(Freq[unemployed == 1]),
    percentage = (unemployed_1 / total) * 100
  ) %>%
  ungroup()

unemployed_quarter_plot <- ggplot(unemployed_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Unemployed",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q1", "2022 Q2", "2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

unemployed_quarter_plot
ggsave("unemployed_quarter_plot.jpg")
```

# Plot data - halves
```{r}
# Medicaid coverage
medicaid_half <- svytable(~medicaid + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_half_plot <- ggplot(medicaid_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has Medicaid",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_half_plot
ggsave("medicaid_half_plot.jpg")

# ESI
esi_half <- svytable(~esi + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_half_plot <- ggplot(esi_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has ESI",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_half_plot
ggsave("esi_half_plot.jpg")

# Uninsured
uninsured_half <- svytable(~uninsured + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_half_plot <- ggplot(uninsured_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Uninsured",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_half_plot
ggsave("uninsured_half_plot.jpg")

# Qualifying activities
qualifying_half <- svytable(~qualifying + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_half_plot <- ggplot(qualifying_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Qualifying activities",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_half_plot
ggsave("qualifying_half_plot.jpg")

# Employed
employed_half <- svytable(~employed + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_half_plot <- ggplot(employed_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Employed",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_half_plot
ggsave("employed_half_plot.jpg")

# Student
student_half <- svytable(~student + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_half_plot <- ggplot(student_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Student",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_half_plot
ggsave("student_half_plot.jpg")

# PCP
pcp_half <- svytable(~pcp + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_half_plot <- ggplot(pcp_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "PCP",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_half_plot
ggsave("pcp_half_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_half <- svytable(~not_afford + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_half_plot <- ggplot(not_afford_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_half_plot
ggsave("not_afford_half_plot.jpg")

# Unemployed
unemployed_half <- svytable(~unemployed + half + intervention, eligible) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    unemployed_1 = sum(Freq[unemployed == 1]),
    percentage = (unemployed_1 / total) * 100
  ) %>%
  ungroup()

unemployed_half_plot <- ggplot(unemployed_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Unemployed",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

unemployed_half_plot
ggsave("unemployed_half_plot.jpg")
```

# Plot data - GA 2022-2023
```{r}
# Medicaid coverage
medicaid_summary <- svytable(~medicaid + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_all_plot <- ggplot(medicaid_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had Medicaid",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_all_plot
ggsave("medicaid_all_plot.jpg")

# ESI
esi_summary <- svytable(~esi + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_all_plot <- ggplot(esi_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Had employer-sponsored insurance",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_all_plot
ggsave("esi_all_plot.jpg")

# Uninsured
uninsured_summary <- svytable(~uninsured + IYEAR + intervention, all_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_all_plot <- ggplot(uninsured_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Uninsured",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_all_plot
ggsave("uninsured_all_plot.jpg")




uninsured_summary <- svytable(~uninsured + IYEAR + intervention, ga_2223) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_all_plot <- ggplot(uninsured_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Uninsured",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_all_plot
ggsave("uninsured_all_plot.jpg")

# Qualifying activities
qualifying_summary <- svytable(~qualifying + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_all_plot <- ggplot(qualifying_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Qualifying activities",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_all_plot
ggsave("qualifying_all_plot.jpg")

# Employed
employed_summary <- svytable(~employed + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_all_plot <- ggplot(employed_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Employed",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_all_plot
ggsave("employed_all_plot.jpg")

# Student
student_summary <- svytable(~student + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_all_plot <- ggplot(student_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Student",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_all_plot
ggsave("student_all_plot.jpg")

# PCP
pcp_summary <- svytable(~pcp + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_all_plot <- ggplot(pcp_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Has PCP",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_all_plot
ggsave("pcp_all_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_summary <- svytable(~not_afford + IYEAR + intervention, working_age_ga) %>%
  as.data.frame() %>%
  group_by(IYEAR, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_all_plot <- ggplot(not_afford_summary, aes(x = intervention, y = percentage, fill = IYEAR)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Group",
    y = "Percentage",
    fill = "Period"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_all_plot
ggsave("not_afford_all_plot.jpg")
```

# Plot data - CVD
```{r}
eligible_cv <- eligible %>%
  subset(
    #IYEAR == 2023 &
      dm == 1 |
      mi == 1 |
      stroke == 1 |
      chd == 1 #|
      # htn == 1 |
      # hld == 1
      )

nrow(eligible_cv)

# Medicaid coverage
medicaid_half <- svytable(~medicaid + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_half_cv_plot <- ggplot(medicaid_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has Medicaid",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_half_cv_plot
ggsave("medicaid_half_cv_plot.jpg")

# ESI
esi_half <- svytable(~esi + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_half_cv_plot <- ggplot(esi_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has ESI",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_half_cv_plot
ggsave("esi_half_cv_plot.jpg")

# Uninsured
uninsured_half <- svytable(~uninsured + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_half_cv_plot <- ggplot(uninsured_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Uninsured",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_half_cv_plot
ggsave("uninsured_half_cv_plot.jpg")

# Qualifying activities
qualifying_half <- svytable(~qualifying + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_half_cv_plot <- ggplot(qualifying_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Qualifying activities",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_half_cv_plot
ggsave("qualifying_half_cv_plot.jpg")

# Employed
employed_half <- svytable(~employed + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_half_cv_plot <- ggplot(employed_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Employed",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_half_cv_plot
ggsave("employed_half_cv_plot.jpg")

# Student
student_half <- svytable(~student + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_half_cv_plot <- ggplot(student_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Student",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_half_cv_plot
ggsave("student_half_cv_plot.jpg")

# PCP
pcp_half <- svytable(~pcp + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_half_cv_plot <- ggplot(pcp_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "PCP",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_half_cv_plot
ggsave("pcp_half_cv_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_half <- svytable(~not_afford + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_half_cv_plot <- ggplot(not_afford_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_half_cv_plot
ggsave("not_afford_half_cv_plot.jpg")

# Unemployed
unemployed_half <- svytable(~unemployed + half + intervention, eligible_cv) %>%
  as.data.frame() %>%
  group_by(half, intervention) %>%
  summarize(
    total = sum(Freq),
    unemployed_1 = sum(Freq[unemployed == 1]),
    percentage = (unemployed_1 / total) * 100
  ) %>%
  ungroup()

unemployed_half_cv_plot <- ggplot(unemployed_half, aes(x = half, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Unemployed",
    x = "Half",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Jan-June", "2022 July-Dec", "2023 Jan-June", "2023 July-Dec")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

unemployed_half_cv_plot
ggsave("unemployed_half_cv_plot.jpg")
```
# Plot data - 1yr quarters
```{r}
eligible_1yr <- survey_2223 %>%
  subset(
    `_STATE` %in% c(13, 1, 12, 48, 28) &
      # Georgia, Alabama, Florida, Texas, Mississippi residents
      `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
      fpg <= 100 & # Income up to 100% FPL
      (PREGNANT != 1 | is.na(PREGNANT)) & # Not pregnant
      (BLIND != 1 | is.na(BLIND)) & # Not legally blind
      (DEAF != 1 | is.na(DEAF)) & # Not deaf
      (DECIDE != 1 | is.na(DECIDE)) & # No difficulty with cognition
      (DIFFWALK != 1 |
         is.na(DIFFWALK)) & # No difficulty with mobility
      (DIFFDRES != 1 |
         is.na(DIFFDRES)) & # No difficulty with self-care
      (DIFFALON != 1 |
         is.na(DIFFALON)) & # No difficulty with independent living
      (children_clean == 0 | (children_clean >= 1 &
         fpg > 30)) & # No parents with income under 30% FPL
      ((IYEAR == 2022 & IMONTH %in% c("07", "08", "09", "10", "11", "12")) | IYEAR == 2023)  # Date range: 7/1/2022 - 12/31/2023
    # Exclude "unable to work"?
  )

# Medicaid coverage
medicaid_quarter <- svytable(~medicaid + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    medicaid_1 = sum(Freq[medicaid == 1]),
    percentage = (medicaid_1 / total) * 100
  ) %>%
  ungroup()

medicaid_quarter_plot <- ggplot(medicaid_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has Medicaid",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

medicaid_quarter_plot
# ggsave("medicaid_quarter_plot.jpg")

# ESI
esi_quarter <- svytable(~esi + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    esi_1 = sum(Freq[esi == 1]),
    percentage = (esi_1 / total) * 100
  ) %>%
  ungroup()

esi_quarter_plot <- ggplot(esi_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Has employer-sponsored insurance",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

esi_quarter_plot
# ggsave("esi_quarter_plot.jpg")

# Uninsured
uninsured_quarter <- svytable(~uninsured + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    uninsured_1 = sum(Freq[uninsured == 1]),
    percentage = (uninsured_1 / total) * 100
  ) %>%
  ungroup()

uninsured_quarter_plot <- ggplot(uninsured_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Uninsured",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

uninsured_quarter_plot
# ggsave("uninsured_quarter_plot.jpg")

# Qualifying activities
qualifying_quarter <- svytable(~qualifying + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    qualifying_1 = sum(Freq[qualifying == 1]),
    percentage = (qualifying_1 / total) * 100
  ) %>%
  ungroup()

qualifying_quarter_plot <- ggplot(qualifying_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Qualifying activities",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

qualifying_quarter_plot
# ggsave("qualifying_quarter_plot.jpg")

# Employed
employed_quarter <- svytable(~employed + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    employed_1 = sum(Freq[employed == 1]),
    percentage = (employed_1 / total) * 100
  ) %>%
  ungroup()

employed_quarter_plot <- ggplot(employed_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Employed",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

employed_quarter_plot
# ggsave("employed_quarter_plot.jpg")

# Student
student_quarter <- svytable(~student + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    student_1 = sum(Freq[student == 1]),
    percentage = (student_1 / total) * 100
  ) %>%
  ungroup()

student_quarter_plot <- ggplot(student_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Student",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

student_quarter_plot
# ggsave("student_quarter_plot.jpg")

# PCP
pcp_quarter <- svytable(~pcp + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    pcp_1 = sum(Freq[pcp == 1]),
    percentage = (pcp_1 / total) * 100
  ) %>%
  ungroup()

pcp_quarter_plot <- ggplot(pcp_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "PCP",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

pcp_quarter_plot
# ggsave("pcp_quarter_plot.jpg")

# Could not afford to see doctor in past 12 months
not_afford_quarter <- svytable(~not_afford + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    not_afford_1 = sum(Freq[not_afford == 1]),
    percentage = (not_afford_1 / total) * 100
  ) %>%
  ungroup()

not_afford_quarter_plot <- ggplot(not_afford_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Could not afford to see doctor in past 12 months",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

not_afford_quarter_plot
# ggsave("not_afford_quarter_plot.jpg")

# Unemployed
unemployed_quarter <- svytable(~unemployed + quarter + intervention, eligible_1yr) %>%
  as.data.frame() %>%
  group_by(quarter, intervention) %>%
  summarize(
    total = sum(Freq),
    unemployed_1 = sum(Freq[unemployed == 1]),
    percentage = (unemployed_1 / total) * 100
  ) %>%
  ungroup()

unemployed_quarter_plot <- ggplot(unemployed_quarter, aes(x = quarter, y = percentage, color = intervention, group = intervention)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Unemployed",
    x = "Quarter",
    y = "Percentage",
    color = ""
  ) +
  scale_x_discrete(labels = c("2022 Q3", "2022 Q4", "2023 Q1", "2023 Q2", "2023 Q3", "2023 Q4")) +
  scale_color_discrete(labels = c("Control States", "Georgia")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

unemployed_quarter_plot
# ggsave("unemployed_quarter_plot.jpg")
```

# Stacked bar graph
```{r}
temp <- merge_2223 %>%
  mutate(
    employment = as.character(EMPLOY1),
    insurance = case_when(
      is.na(PRIMINS1) ~ as.character(PRIMINSR),
      is.na(PRIMINSR) ~ as.character(PRIMINS1)
    )
  ) %>%
  filter(
    state == "Georgia" & `_AGE80` >= 19 & `_AGE80` <= 64
  )

temp_survey <- svydesign(id = ~`_PSU`, strata = ~`_STSTR`, weights = ~`_LLCPWT`, data = temp, nest = TRUE)

# Calculate weighted proportions of EMPLOY1 by quarter
employment_proportions <- svyby(
  ~employment, 
  ~quarter, 
  temp_survey, 
  svymean, 
  vartype = "ci", 
  na.rm = TRUE
)

# Convert proportions to percentage
employment_proportions_long <- as.data.frame(employment_proportions) %>%
  pivot_longer(cols = starts_with("employment"), names_to = "employment", values_to = "proportion") %>%
  mutate(proportion = proportion * 100)  # Convert to percentage

# Create the stacked bar graph
ggplot(employment_proportions_long, aes(x = factor(quarter), y = proportion, fill = employment)) +
  geom_bar(stat = "identity") +
  labs(x = "Quarter", y = "Percentage", fill = "Employment Status") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Convert y-axis to percentage format
  theme_minimal() +
  ggtitle("Employment Status by Quarter")

# Calculate weighted proportions of EMPLOY1 by quarter
insurance_proportions <- svyby(
  ~insurance, 
  ~quarter, 
  temp_survey, 
  svymean, 
  vartype = "ci", 
  na.rm = TRUE
)

# Convert proportions to percentage
insurance_proportions_long <- as.data.frame(insurance_proportions) %>%
  pivot_longer(cols = starts_with("insurance"), names_to = "insurance", values_to = "proportion") %>%
  mutate(proportion = proportion * 100)  # Convert to percentage

# Create the stacked bar graph
ggplot(insurance_proportions_long, aes(x = factor(quarter), y = proportion, fill = insurance)) +
  geom_bar(stat = "identity") +
  labs(x = "Quarter", y = "Percentage", fill = "Employment Status") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Convert y-axis to percentage format
  theme_minimal() +
  ggtitle("Insurance Status by Quarter")
```

# Respondent characteristics
```{r}
# Define a function to generate a table and chi-square test
gen_table_chisq <- function(variable, group_var, survey_design) {
  # Calculate the weighted percentages and confidence intervals for the input variable by the group variable
  tbl <- svyby(as.formula(paste("~", variable)), as.formula(paste("~", group_var)), survey_design, svymean, vartype = c("ci"), na.rm = TRUE)
  
  # Generate a Chi-square test to compare the input variable across the group variable
  chi_test <- svychisq(as.formula(paste("~", variable, "+", group_var)), design = survey_design)
  
  # Return the table and chi-square test result as a list
  list(
    table = tbl,
    chi_square = chi_test
  )
}

# Split sample into pre and post
eligible_pre <- eligible %>%
  subset(post == 0)

eligible_post <- eligible %>%
  subset(post == 1)

# Total study population
total <- svytable(~intervention, design = eligible) %>% as.data.frame()
total

# Tabulate weighted respondent characteristics in pre period
total_tbl_pre_u <- table(eligible_pre$variables$intervention)
total_tbl_pre_u

total_tbl_pre_w <- svytable(~intervention, design = eligible_pre) %>% as.data.frame()
total_tbl_pre_w

age_tbl_pre <- svyby(~age, ~intervention, eligible_pre, svymean, vartype = c("se"), na.rm = TRUE)
age_tbl_pre
age_tbl_pre_p <- svyttest(age~intervention, eligible_pre)
age_tbl_pre_p

sex_tbl_pre <- gen_table_chisq("sex_cat", "intervention", eligible_pre)
sex_tbl_pre$table
sex_tbl_pre$chi_square

race_tbl_pre <- gen_table_chisq("race_cat", "intervention", eligible_pre)
race_tbl_pre$table
race_tbl_pre$chi_square

education_tbl_pre <- gen_table_chisq("education_cat", "intervention", eligible_pre)
education_tbl_pre$table
education_tbl_pre$chi_square

dm_tbl_pre <- gen_table_chisq("dm", "intervention", eligible_pre)
dm_tbl_pre$table
dm_tbl_pre$chi_square

mi_tbl_pre <- gen_table_chisq("mi", "intervention", eligible_pre)
mi_tbl_pre$table
mi_tbl_pre$chi_square

stroke_tbl_pre <- gen_table_chisq("stroke", "intervention", eligible_pre)
stroke_tbl_pre$table
stroke_tbl_pre$chi_square

copd_tbl_pre <- gen_table_chisq("copd", "intervention", eligible_pre)
copd_tbl_pre$table
copd_tbl_pre$chi_square

cancer_tbl_pre <- gen_table_chisq("cancer", "intervention", eligible_pre)
cancer_tbl_pre$table
cancer_tbl_pre$chi_square

# Tabulate weighted respondent characteristics in post periods
total_tbl_post_u <- table(eligible_post$variables$intervention)
total_tbl_post_u

total_tbl_post_w <- svytable(~intervention, design = eligible_post) %>% as.data.frame()
total_tbl_post_w

age_tbl_post <- svyby(~age, ~intervention, eligible_post, svymean, vartype = c("se"), na.rm = TRUE)
age_tbl_post
age_tbl_post_p <- svyttest(age~intervention, eligible_post)
age_tbl_post_p

sex_tbl_post <- gen_table_chisq("sex_cat", "intervention", eligible_post)
sex_tbl_post$table
sex_tbl_post$chi_square

race_tbl_post <- gen_table_chisq("race_cat", "intervention", eligible_post)
race_tbl_post$table
race_tbl_post$chi_square

education_tbl_post <- gen_table_chisq("education_cat", "intervention", eligible_post)
education_tbl_post$table
education_tbl_post$chi_square

dm_tbl_post <- gen_table_chisq("dm", "intervention", eligible_post)
dm_tbl_post$table
dm_tbl_post$chi_square

mi_tbl_post <- gen_table_chisq("mi", "intervention", eligible_post)
mi_tbl_post$table
mi_tbl_post$chi_square

stroke_tbl_post <- gen_table_chisq("stroke", "intervention", eligible_post)
stroke_tbl_post$table
stroke_tbl_post$chi_square

copd_tbl_post <- gen_table_chisq("copd", "intervention", eligible_post)
copd_tbl_post$table
copd_tbl_post$chi_square

cancer_tbl_post <- gen_table_chisq("cancer", "intervention", eligible_post)
cancer_tbl_post$table
cancer_tbl_post$chi_square
```

# Unadjusted DID analysis
```{r}
# Medicaid
medicaid_unadj <- svyglm(medicaid ~ intervention * post, design = eligible)
summary(medicaid_unadj)

# Uninsured
uninsured_unadj <- svyglm(uninsured ~ intervention * post, design = eligible)
summary(uninsured_unadj)

# Qualifying activities
qualifying_unadj <- svyglm(qualifying ~ intervention * post, design = eligible)
summary(qualifying_unadj)

# Employed
employed_unadj <- svyglm(employed ~ intervention * post, design = eligible)
summary(employed_unadj)

# Student
student_unadj <- svyglm(student ~ intervention * post, design = eligible)
summary(student_unadj)

# Employer-sponsored insurance
esi_unadj <- svyglm(esi ~ intervention * post, design = eligible)
summary(esi_unadj)

# Access to PCP
pcp_unadj <- svyglm(pcp ~ intervention * post, design = eligible)
summary(pcp_unadj)

# Cost-related delays in care
not_afford_unadj <- svyglm(not_afford ~ intervention * post, design = eligible)
summary(not_afford_unadj)
```

# Adjusted DID analysis
```{r}
# Medicaid
medicaid_adj <- svyglm(medicaid ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(medicaid_adj)

# Uninsured
uninsured_adj <- svyglm(uninsured ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(uninsured_adj)

# Qualifying activities
qualifying_adj <- svyglm(qualifying ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(qualifying_adj)

# Employed
employed_adj <- svyglm(employed ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(employed_adj)

# Student
student_adj <- svyglm(student ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(student_adj)

# Employer-sponsored insurance
esi_adj <- svyglm(esi ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(esi_adj)

# Access to PCP
pcp_adj <- svyglm(pcp ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(pcp_adj)

# Cost-related delays in care
not_afford_adj <- svyglm(not_afford ~ intervention * post + age_cat + sex_cat + race_cat, design = eligible)
summary(not_afford_adj)
```

# Create DID table
```{r}
# Define function to fill in diff-in-diff table
gen_did_tbl <- function(outcome_var, unadj_model, adj_model, survey_design, z_value = 1.96) {
  # Tabulate the average percentages in the pre and post time periods for intervention == 1
  tbl_t <- svyby(as.formula(paste0("~", outcome_var)), ~post, subset(survey_design, intervention == 1), svymean, vartype = c("ci"), na.rm = TRUE)
  
  # Tabulate the average percentages in the pre and post time periods for intervention == 0
  tbl_c <- svyby(as.formula(paste0("~", outcome_var)), ~post, subset(survey_design, intervention == 0), svymean, vartype = c("ci"), na.rm = TRUE)
  
  # Extract the means and confidence intervals for intervention == 1 
  pre_mean_t <- tbl_t[tbl_t$post == 0, outcome_var]
  ci_pre_low_t <- tbl_t[tbl_t$post == 0, "ci_l"]
  ci_pre_upp_t <- tbl_t[tbl_t$post == 0, "ci_u"]
  post_mean_t <- tbl_t[tbl_t$post == 1, outcome_var]
  ci_post_low_t <- tbl_t[tbl_t$post == 1, "ci_l"]
  ci_post_upp_t <- tbl_t[tbl_t$post == 1, "ci_u"]
  
  # Convert to percentage points for intervention == 1
  pre_mean_percent_t <- pre_mean_t * 100
  ci_pre_low_percent_t <- ci_pre_low_t * 100
  ci_pre_upp_percent_t <- ci_pre_upp_t * 100
  post_mean_percent_t <- post_mean_t * 100
  ci_post_low_percent_t <- ci_post_low_t * 100
  ci_post_upp_percent_t <- ci_post_upp_t * 100
  
  # Calculate the difference for intervention == 1
  diff_mean_t <- post_mean_t - pre_mean_t
  
  # Calculate the standard error of the difference for intervention == 1
  diff_se_t <- sqrt((((tbl_t[tbl_t$post == 1, "ci_u"] - post_mean_t))/z_value)^2 + 
                    (((pre_mean_t - tbl_t[tbl_t$post == 0, "ci_l"]))/z_value)^2)
  
  # Calculate the confidence interval for intervention == 1
  ci_diff_low_t <- diff_mean_t - z_value * diff_se_t
  ci_diff_upp_t <- diff_mean_t + z_value * diff_se_t
  
  # Convert to percentage points for intervention == 1
  diff_mean_percent_t <- diff_mean_t * 100
  ci_diff_low_percent_t <- ci_diff_low_t * 100
  ci_diff_upp_percent_t <- ci_diff_upp_t * 100
  
  # Extract the means and confidence intervals for intervention == 0
  pre_mean_c <- tbl_c[tbl_c$post == 0, outcome_var]
  ci_pre_low_c <- tbl_c[tbl_c$post == 0, "ci_l"]
  ci_pre_upp_c <- tbl_c[tbl_c$post == 0, "ci_u"]
  post_mean_c <- tbl_c[tbl_c$post == 1, outcome_var]
  ci_post_low_c <- tbl_c[tbl_c$post == 1, "ci_l"]
  ci_post_upp_c <- tbl_c[tbl_c$post == 1, "ci_u"]
  
  # Convert to percentage points for intervention == 0
  pre_mean_percent_c <- pre_mean_c * 100
  ci_pre_low_percent_c <- ci_pre_low_c * 100
  ci_pre_upp_percent_c <- ci_pre_upp_c * 100
  post_mean_percent_c <- post_mean_c * 100
  ci_post_low_percent_c <- ci_post_low_c * 100
  ci_post_upp_percent_c <- ci_post_upp_c * 100
  
  # Calculate the difference for intervention == 0
  diff_mean_c <- post_mean_c - pre_mean_c
  
  # Calculate p value for intervention == 1
  did_ttest_t <- svyttest(as.formula(paste0(outcome_var, " ~ post")), design = subset(survey_design, intervention == 1))
  did_pval_t <- formatC(did_ttest_t$p.value, format = "f", digits = 4)
  
  # Calculate the standard error of the difference for intervention == 0
  diff_se_c <- sqrt((((tbl_c[tbl_c$post == 1, "ci_u"] - post_mean_c))/z_value)^2 +
                    (((pre_mean_c - tbl_c[tbl_c$post == 0, "ci_l"]))/z_value)^2)
  
  # Calculate the confidence interval for intervention == 0
  ci_diff_low_c <- diff_mean_c - z_value * diff_se_c
  ci_diff_upp_c <- diff_mean_c + z_value * diff_se_c
  
  # Convert to percentage points for intervention == 0
  diff_mean_percent_c <- diff_mean_c * 100
  ci_diff_low_percent_c <- ci_diff_low_c * 100
  ci_diff_upp_percent_c <- ci_diff_upp_c * 100
  
  # Calculate p value for intervention == 0
  did_ttest_c <- svyttest(as.formula(paste0(outcome_var, " ~ post")), design = subset(survey_design, intervention == 0))
  did_pval_c <- formatC(did_ttest_c$p.value, format = "f", digits = 4)
  
  # Print the results for intervention == 1
  cat("Intervention group:\n")
  cat(paste0("Pre period mean: ", formatC(pre_mean_percent_t, format = "f", digits = 2), "% (", 
             formatC(ci_pre_low_percent_t, format = "f", digits = 2), "%, ", 
             formatC(ci_pre_upp_percent_t, format = "f", digits = 2), "%)\n"))
  cat(paste0("Post period mean: ", formatC(post_mean_percent_t, format = "f", digits = 2), "% (", 
             formatC(ci_post_low_percent_t, format = "f", digits = 2), "%, ",
             formatC(ci_post_upp_percent_t, format = "f", digits = 2), "%)\n"))
  cat(paste0("Difference: ", formatC(diff_mean_percent_t, format = "f", digits = 2), "% (", 
             formatC(ci_diff_low_percent_t, format = "f", digits = 2), "%, ",
             formatC(ci_diff_upp_percent_t, format = "f", digits = 2), "%)\n"))
  cat(paste0("P value: ", formatC(did_pval_t, format = "f", digits = 4), "\n\n"))
  
  # Print the results for intervention == 0
  cat("Control group:\n")
  cat(paste0("Pre period mean: ", formatC(pre_mean_percent_c, format = "f", digits = 2), "% (", 
             formatC(ci_pre_low_percent_c, format = "f", digits = 2), "%, ",
             formatC(ci_pre_upp_percent_c, format = "f", digits = 2), "%)\n"))
  cat(paste0("Post period mean: ", formatC(post_mean_percent_c, format = "f", digits = 2), "% (", 
             formatC(ci_post_low_percent_c, format = "f", digits = 2), "%, ",
             formatC(ci_post_upp_percent_c, format = "f", digits = 2), "%)\n"))
  cat(paste0("Difference: ", formatC(diff_mean_percent_c, format = "f", digits = 2), "% (", 
             formatC(ci_diff_low_percent_c, format = "f", digits = 2), "%, ",
             formatC(ci_diff_upp_percent_c, format = "f", digits = 2), "%)\n"))
  cat(paste0("P value: ", formatC(did_pval_c, format = "f", digits = 4), "\n\n"))
  
  # # Difference-in-differences (DiD) calculation
  # did_diff_mean <- diff_mean_percent_t - diff_mean_percent_c
  # 
  # # Standard error of the DiD estimate
  # did_se <- sqrt(diff_se_t^2 + diff_se_c^2)
  # 
  # # Confidence interval for the DiD estimate
  # ci_did_low <- did_diff_mean - z_value * did_se * 100
  # ci_did_upp <- did_diff_mean + z_value * did_se * 100
  # 
  # # Print the DiD results
  # cat("Difference-in-Differences (DiD):\n")
  # cat(paste0("DiD estimate: ", formatC(did_diff_mean, format = "f", digits = 2), " (", 
  #            formatC(ci_did_low, format = "f", digits = 2), ", ",
  #            formatC(ci_did_upp, format = "f", digits = 2), ")\n"))
  
  # Extract estimates, confidence intervals, and p-values for both models
  
  # Unadjusted Model
  unadj_diff_in_diff <- coef(unadj_model)["intervention:post"] * 100
  unadj_ci <- confint(unadj_model)["intervention:post", ] * 100
  unadj_p_value <- summary(unadj_model)$coefficients["intervention:post", "Pr(>|t|)"]
  
  # Adjusted Model
  adj_diff_in_diff <- coef(adj_model)["intervention:post"] * 100
  adj_ci <- confint(adj_model)["intervention:post", ] * 100
  adj_p_value <- summary(adj_model)$coefficients["intervention:post", "Pr(>|t|)"]
  
  # Print the results for the unadjusted model
  cat("\nUnadjusted Model:\n")
  cat(paste0("Difference-in-Difference Estimate: ", formatC(unadj_diff_in_diff, format = "f", digits = 2), "% (", 
      formatC(unadj_ci[1], format = "f", digits = 2), "%, ", 
      formatC(unadj_ci[2], format = "f", digits = 2), "%)\n"))
  cat(paste0("p-value: ", formatC(unadj_p_value, format = "f", digits = 2), "\n"))
  
  # Print the results for the adjusted model
  cat(paste0("\nAdjusted Model:\n"))
  cat(paste0("Difference-in-Difference Estimate: ", formatC(adj_diff_in_diff, format = "f", digits = 2), "% (", 
      formatC(adj_ci[1], format = "f", digits = 2), "%, ", 
      formatC(adj_ci[2], format = "f", digits = 2), "%)\n"))
  cat(paste0("p-value: ", formatC(adj_p_value, format = "f", digits = 2), "\n"))
}

# Run on outcomes
gen_did_tbl("medicaid", medicaid_unadj, medicaid_adj, eligible)
gen_did_tbl("esi", esi_unadj, esi_adj, eligible)
gen_did_tbl("uninsured", uninsured_unadj, uninsured_adj, eligible)
gen_did_tbl("qualifying", qualifying_unadj, qualifying_adj, eligible)
gen_did_tbl("employed", employed_unadj, employed_adj, eligible)
gen_did_tbl("student", student_unadj, student_adj, eligible)
gen_did_tbl("pcp", pcp_unadj, pcp_adj, eligible)
gen_did_tbl("not_afford", not_afford_unadj, not_afford_adj, eligible)
```