---
title: "Georgia Medicaid Work Requirements"
output: html_document
date: "2024-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r libraries}
library(tidyverse)
library(haven)
library(summarytools)
library(survey)
```

## Load data

```{r}
# Load the datasets
llcp2022 <- read_xpt("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/BRFSS/Data/LLCP2022.XPT")
llcp2023 <- read_xpt("C:/Users/djohns44/OneDrive - Beth Israel Lahey Health/BRFSS/Data/LLCP2023.XPT")
```

# Clean BRFSS 2022
```{r}
# Federal Poverty 2022 calculations
llcp2022 <- llcp2022 %>%
  mutate(
    hhadult_clean = ifelse(HHADULT %in% c(77, 99), NA, HHADULT),
    children_clean = ifelse(CHILDREN == 99, NA, ifelse(CHILDREN == 88, 0, CHILDREN)),
    hh_size = ifelse(is.na(NUMADULT), 1, NUMADULT) + ifelse(is.na(hhadult_clean), 0, hhadult_clean) + ifelse(is.na(children_clean), 0, children_clean),
    hh_size = ifelse(hh_size == 0 | hh_size > 9, 1, hh_size), # Exclude 0 or >99th percentile (9)
    income_num = case_when(
      INCOME3 == 1 ~ 5000,
      INCOME3 == 2 ~ 12500,
      INCOME3 == 3 ~ 17500,
      INCOME3 == 4 ~ 22500,
      INCOME3 == 5 ~ 30000,
      INCOME3 == 6 ~ 42500,
      INCOME3 == 7 ~ 62500,
      INCOME3 == 8 ~ 87500,
      INCOME3 == 9 ~ 125000,
      INCOME3 == 10 ~ 175000,
      INCOME3 == 11 ~ 200000,
      TRUE ~ NA_real_
    ),
    fpg = case_when(
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 1 ~ 100 * (income_num / 13590),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 2 ~ 100 * (income_num / 18310),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 3 ~ 100 * (income_num / 23030),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 4 ~ 100 * (income_num / 27750),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 5 ~ 100 * (income_num / 32470),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 6 ~ 100 * (income_num / 37190),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 7 ~ 100 * (income_num / 41910),
      `_STATE` != 2 & `_STATE` != 15 & hh_size >= 8 ~ 100 * (income_num / (46630 + (hh_size - 8) * 4720)),
      `_STATE` == 2 & hh_size == 1 ~ 100 * (income_num / 16990),
      `_STATE` == 2 & hh_size == 2 ~ 100 * (income_num / 22890),
      `_STATE` == 2 & hh_size == 3 ~ 100 * (income_num / 28790),
      `_STATE` == 2 & hh_size == 4 ~ 100 * (income_num / 34690),
      `_STATE` == 2 & hh_size == 5 ~ 100 * (income_num / 40590),
      `_STATE` == 2 & hh_size == 6 ~ 100 * (income_num / 46490),
      `_STATE` == 2 & hh_size == 7 ~ 100 * (income_num / 52390),
      `_STATE` == 2 & hh_size >= 8 ~ 100 * (income_num / (58290 + (hh_size - 8) * 5900)),
      `_STATE` == 15 & hh_size == 1 ~ 100 * (income_num / 15630),
      `_STATE` == 15 & hh_size == 2 ~ 100 * (income_num / 21060),
      `_STATE` == 15 & hh_size == 3 ~ 100 * (income_num / 26490),
      `_STATE` == 15 & hh_size == 4 ~ 100 * (income_num / 31920),
      `_STATE` == 15 & hh_size == 5 ~ 100 * (income_num / 37350),
      `_STATE` == 15 & hh_size == 6 ~ 100 * (income_num / 42780),
      `_STATE` == 15 & hh_size == 7 ~ 100 * (income_num / 48210),
      `_STATE` == 15 & hh_size >= 8 ~ 100 * (income_num / (53640 + (hh_size - 8) * 5430)),
      TRUE ~ NA_real_
    ),
    age_cat = case_when(
      `_AGE80` >= 18 & `_AGE80` <= 24 ~ "18-24",
      `_AGE80` >= 25 & `_AGE80` <= 34 ~ "25-34",
      `_AGE80` >= 35 & `_AGE80` <= 44 ~ "35-44",
      `_AGE80` >= 45 & `_AGE80` <= 54 ~ "45-54",
      `_AGE80` >= 55 & `_AGE80` <= 64 ~ "55-64",
      `_AGE80` >= 65 ~ ">65",
      TRUE ~ NA_character_
    ),
    sex_cat = case_when(
      SEXVAR == 1 ~ "1.Male",
      SEXVAR == 2 ~ "2.Female",
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      `_IMPRACE` == 1 ~ "1.Non-Hispanic White",
      `_IMPRACE` == 2 ~ "2.Non-Hispanic Black",
      `_IMPRACE` == 3 ~ "3.Non-Hispanic Asian",
      `_IMPRACE` == 5 ~ "4.Hispanic",
      `_IMPRACE` %in% c(4, 6) ~ "5.Other",
      TRUE ~ NA_character_
    ),
    education_cat = case_when(
      EDUCA %in% c(5, 6) ~ "College educated",
      EDUCA %in% c(1, 2, 3, 4) ~ "Not college educated",
      TRUE ~ NA_character_
    ),
    medicaid = ifelse(PRIMINSR == 5, 1, 0),
    esi = ifelse(PRIMINSR == 1, 1, 0),
    uninsured = ifelse(`_HLTHPL1` == 2, 1, ifelse(`_HLTHPL1` == 1, 0, NA)),
    employed = ifelse(EMPLOY1 %in% c(1, 2), 1, 0),
    student = ifelse(EMPLOY1 == 6, 1, 0),
    qualifying = ifelse(EMPLOY1 %in% c(1, 2, 6), 1, 0),
    pcp = ifelse(PERSDOC3 %in% c(1, 2), 1, ifelse(PERSDOC3 == 3, 0, NA)),
    not_afford = ifelse(MEDCOST1 == 1, 1, ifelse(MEDCOST1 == 2, 0, NA)),
    dm = ifelse(DIABETE4 %in% c(1, 2), 1, ifelse(DIABETE4 %in% c(3, 4), 0, NA)),
    mi = ifelse(CVDINFR4 == 1, 1, ifelse(CVDINFR4 == 2, 0, NA)),
    stroke = ifelse(CVDSTRK3 == 1, 1, ifelse(CVDSTRK3 == 2, 0, NA)),
    copd = ifelse(CHCCOPD3 == 1, 1, ifelse(CHCCOPD3 == 2, 0, NA)),
    cancer = ifelse(CHCOCNC1 == 1, 1, ifelse(CHCOCNC1 == 2, 0, NA))
  )
```

# Clean BRFSS 2023
```{r}
# Federal Poverty 2023 calculations
llcp2023 <- llcp2023 %>%
  mutate(
    hhadult_clean = ifelse(HHADULT %in% c(77, 99), NA, HHADULT),
    children_clean = ifelse(CHILDREN == 99, NA, ifelse(CHILDREN == 88, 0, CHILDREN)),
    hh_size = ifelse(is.na(NUMADULT), 1, NUMADULT) + ifelse(is.na(hhadult_clean), 0, hhadult_clean) + ifelse(is.na(children_clean), 0, children_clean),
    hh_size = ifelse(hh_size == 0 | hh_size > 9, 1, hh_size), # Exclude 0 or >99th percentile (9)
    income_num = case_when(
      INCOME3 == 1 ~ 5000,
      INCOME3 == 2 ~ 12500,
      INCOME3 == 3 ~ 17500,
      INCOME3 == 4 ~ 22500,
      INCOME3 == 5 ~ 30000,
      INCOME3 == 6 ~ 42500,
      INCOME3 == 7 ~ 62500,
      INCOME3 == 8 ~ 87500,
      INCOME3 == 9 ~ 125000,
      INCOME3 == 10 ~ 175000,
      INCOME3 == 11 ~ 200000,
      TRUE ~ NA_real_
    ),
    fpg = case_when(
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 1 ~ 100 * (income_num / 14580),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 2 ~ 100 * (income_num / 19720),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 3 ~ 100 * (income_num / 24860),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 4 ~ 100 * (income_num / 30000),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 5 ~ 100 * (income_num / 35140),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 6 ~ 100 * (income_num / 40280),
      `_STATE` != 2 & `_STATE` != 15 & hh_size == 7 ~ 100 * (income_num / 45420),
      `_STATE` != 2 & `_STATE` != 15 & hh_size >= 8 ~ 100 * (income_num / (50560 + (hh_size - 8) * 5140)),
      `_STATE` == 2 & hh_size == 1 ~ 100 * (income_num / 18210),
      `_STATE` == 2 & hh_size == 2 ~ 100 * (income_num / 24640),
      `_STATE` == 2 & hh_size == 3 ~ 100 * (income_num / 31070),
      `_STATE` == 2 & hh_size == 4 ~ 100 * (income_num / 37500),
      `_STATE` == 2 & hh_size == 5 ~ 100 * (income_num / 43930),
      `_STATE` == 2 & hh_size == 6 ~ 100 * (income_num / 50360),
      `_STATE` == 2 & hh_size == 7 ~ 100 * (income_num / 56790),
      `_STATE` == 2 & hh_size >= 8 ~ 100 * (income_num / (63220 + (hh_size - 8) * 6430)),
      `_STATE` == 15 & hh_size == 1 ~ 100 * (income_num / 16770),
      `_STATE` == 15 & hh_size == 2 ~ 100 * (income_num / 22680),
      `_STATE` == 15 & hh_size == 3 ~ 100 * (income_num / 28590),
      `_STATE` == 15 & hh_size == 4 ~ 100 * (income_num / 34500),
      `_STATE` == 15 & hh_size == 5 ~ 100 * (income_num / 40410),
      `_STATE` == 15 & hh_size == 6 ~ 100 * (income_num / 46320),
      `_STATE` == 15 & hh_size == 7 ~ 100 * (income_num / 52230),
      `_STATE` == 15 & hh_size >= 8 ~ 100 * (income_num / (58140 + (hh_size - 8) * 5910)),
      TRUE ~ NA_real_
    ),
    age_cat = case_when(
      `_AGE80` >= 18 & `_AGE80` <= 24 ~ "18-24",
      `_AGE80` >= 25 & `_AGE80` <= 34 ~ "25-34",
      `_AGE80` >= 35 & `_AGE80` <= 44 ~ "35-44",
      `_AGE80` >= 45 & `_AGE80` <= 54 ~ "45-54",
      `_AGE80` >= 55 & `_AGE80` <= 64 ~ "55-64",
      `_AGE80` >= 65 ~ ">65",
      TRUE ~ NA_character_
    ),
    sex_cat = case_when(
      SEXVAR == 1 ~ "1.Male",
      SEXVAR == 2 ~ "2.Female",
      TRUE ~ NA_character_
    ),
    race_cat = case_when(
      `_IMPRACE` == 1 ~ "1.Non-Hispanic White",
      `_IMPRACE` == 2 ~ "2.Non-Hispanic Black",
      `_IMPRACE` == 3 ~ "3.Non-Hispanic Asian",
      `_IMPRACE` == 5 ~ "4.Hispanic",
      `_IMPRACE` %in% c(4, 6) ~ "5.Other",
      TRUE ~ NA_character_
    ),
    education_cat = case_when(
      EDUCA %in% c(5, 6) ~ "College educated",
      EDUCA %in% c(1, 2, 3, 4) ~ "Not college educated",
      TRUE ~ NA_character_
    ),
    medicaid = ifelse(PRIMINS1 == 5, 1, 0),
    esi = ifelse(PRIMINS1 == 1, 1, 0),
    uninsured = ifelse(`_HLTHPL1` == 2, 1, ifelse(`_HLTHPL1` == 1, 0, NA)),
    employed = ifelse(EMPLOY1 %in% c(1, 2), 1, 0),
    student = ifelse(EMPLOY1 == 6, 1, 0),
    qualifying = ifelse(EMPLOY1 %in% c(1, 2, 6), 1, 0),
    pcp = ifelse(PERSDOC3 %in% c(1, 2), 1, ifelse(PERSDOC3 == 3, 0, NA)),
    not_afford = ifelse(MEDCOST1 == 1, 1, ifelse(MEDCOST1 == 2, 0, NA)),
    dm = ifelse(DIABETE4 %in% c(1, 2), 1, ifelse(DIABETE4 %in% c(3, 4), 0, NA)),
    mi = ifelse(CVDINFR4 == 1, 1, ifelse(CVDINFR4 == 2, 0, NA)),
    stroke = ifelse(CVDSTRK3 == 1, 1, ifelse(CVDSTRK3 == 2, 0, NA)),
    copd = ifelse(CHCCOPD3 == 1, 1, ifelse(CHCCOPD3 == 2, 0, NA)),
    cancer = ifelse(CHCOCNC1 == 1, 1, ifelse(CHCOCNC1 == 2, 0, NA))
  )
```

# Merge data
```{r}
# Merge datasets
merge_2223 <- bind_rows(llcp2022, llcp2023)
```

# Clean merged data
```{r}
merge_2223 <- merge_2223 %>%
  mutate(
    post = case_when(
      IYEAR == 2022 ~ 0,
      IYEAR == 2023 & IMONTH %in% 1:6 ~ 0,
      (IYEAR == 2023 & IMONTH %in% 7:12) | IYEAR == 2024 ~ 1,
      TRUE ~ NA_real_
    ),
    intervention = case_when(
      `_STATE` == 13 ~ 1, # Georgia
      `_STATE` %in% c(1, 12, 48, 28) ~ 0, # Alabama, Florida, Texas, Mississippi
      TRUE ~ NA_real_
    )
  )

summary(merge_2223$fpg)
table(merge_2223$`_AGE80`, useNA = "ifany")
table(merge_2223$EMPLOY1, useNA = "ifany")
table(merge_2223$BLIND, useNA = "ifany")
table(merge_2223$DEAF, useNA = "ifany")
table(merge_2223$DECIDE, useNA = "ifany")
table(merge_2223$DIFFWALK, useNA = "ifany")
table(merge_2223$DIFFDRES, useNA = "ifany")
table(merge_2223$DIFFALON, useNA = "ifany")
```

# Create survey object
```{r}
# Create survey design object
survey_2223 <- svydesign(id = ~`_PSU`, strata = ~`_STSTR`, weights = ~`_LLCPWT`, data = merge_2223, nest = TRUE)

# Handle single-PSU strata by treating them as adjusted PSU
options(survey.lonely.psu = "adjust")
```

# Select target population
```{r}
eligible <- survey_2223 %>%
  subset(
    `_STATE` %in% c(13, 1, 12, 48, 28) &
      # Georgia, Alabama, Florida, Texas, Mississippi residents
      `_AGE80` >= 19 & `_AGE80` <= 64 & # 19-64 years old
      fpg <= 100 & # Income up to 100% FPL
      (PREGNANT != 1 | is.na(PREGNANT)) & # Not pregnant
      (BLIND != 1 | is.na(BLIND)) & # Not legally blind
      (DEAF != 1 | is.na(DEAF)) & # Not deaf
      (DECIDE != 1 | is.na(DECIDE)) & # No difficulty with cognition
      (DIFFWALK != 1 |
         is.na(DIFFWALK)) & # No difficulty with mobility
      (DIFFDRES != 1 |
         is.na(DIFFDRES)) & # No difficulty with self-care
      (DIFFALON != 1 |
         is.na(DIFFALON)) & # No difficulty with independent living
      (children_clean >= 1 & fpg > 30) # No parents with income under 30% FPL
  )
```

# Data exploration
```{r}
# Unweighted data
summary(eligible_uw_medicaid$fpg)
table(eligible_uw_medicaid$`_AGE80`, useNA = "ifany")
table(eligible_uw_medicaid$EMPLOY1, useNA = "ifany")
table(eligible_uw_medicaid$BLIND, useNA = "ifany")
table(eligible_uw_medicaid$DEAF, useNA = "ifany")
table(eligible_uw_medicaid$DECIDE, useNA = "ifany")
table(eligible_uw_medicaid$DIFFWALK, useNA = "ifany")
table(eligible_uw_medicaid$DIFFDRES, useNA = "ifany")
table(eligible_uw_medicaid$DIFFALON, useNA = "ifany")

# Unweighted number of observations
nrow(eligible) # 331

# Weighted number of observations
svytable(~`_STATE`, eligible) # 571493

# Time period
svytable(~IYEAR + IMONTH, eligible) # 415,685 from July 2023 - January 2024
table(eligible_uw$IYEAR, eligible_uw$IMONTH) # 250 from July 2023 - January 2024

# Insurance coverage
svytable(~PRIMINS1, eligible)

# Insurance coverage by month
svytable(~PRIMINS1 + IMONTH + IYEAR, eligible) # 49014.37 on Medicaid during pre-period?
table(eligible_uw$PRIMINS1, eligible_uw$IMONTH, useNA = "always") # 24 on Medicaid during pre-period?

# Employment
svytable(~EMPLOY1, eligible) # 361332.8 employed or in school
```

# DID analysis
```{r}
# Medicaid rate
# HLTHPLN1_model <- svyglm(HLTHPLN1_flag ~ treated * time, design = survey_design, family = quasibinomial())

# Uninsurance rate

# Employment rate

# Employer-sponsored insurance

# Access to PCP
# PERSDOC3_model <- svyglm(PERSDOC3_flag ~ treated * time, design = survey_design, family = quasibinomial())

# Cost-related delays in care
```